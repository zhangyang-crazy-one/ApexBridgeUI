# 全层拖拽和尺寸调整功能

## 📋 功能概述

成功将拖拽和尺寸调整功能扩展到企业数据架构的所有四层，实现了统一的交互体验。

**实施日期**: 2025-11-01  
**实施状态**: ✅ 已完成

---

## ✨ 新增功能

### 1. 概念模型层（Conceptual Layer）
- ✅ 企业数据模型节点可拖拽
- ✅ 节点尺寸可调整（默认400px × 70px，最小60px × 40px）
- ✅ 拖拽时连接线实时跟随
- ✅ 点击节点显示详情

### 2. 主题域层（Subject Layer）
- ✅ 8个主题域节点可拖拽
- ✅ 节点尺寸可调整（默认140px × 80px，最小60px × 40px）
- ✅ 拖拽时垂直和水平连接线实时跟随
- ✅ 点击节点显示详情

### 3. 逻辑模型层（Logical Layer）
- ✅ 8个逻辑模型节点可拖拽
- ✅ 节点尺寸可调整（默认140px × 80px，最小60px × 40px）
- ✅ 拖拽时连接线实时跟随
- ✅ 点击节点显示详情

### 4. 物理模型层（Physical Layer）
- ✅ 24个物理模型节点可拖拽（已有功能）
- ✅ 节点尺寸可调整（默认90px × 60px，最小60px × 40px）
- ✅ **新布局规则**：奇偶交替排列
  - 奇数主题域（客户、产品、财务、营销）：上1下2
  - 偶数主题域（订单、供应链、人力资源、服务）：上2下1

---

## 🎯 物理模型层布局优化

### 新的布局规则

**主题域顺序**（从左到右）：
1. **客户**（奇数）→ 上1下2
2. **订单**（偶数）→ 上2下1
3. **产品**（奇数）→ 上1下2
4. **供应链**（偶数）→ 上2下1
5. **财务**（奇数）→ 上1下2
6. **人力资源**（偶数）→ 上2下1
7. **营销**（奇数）→ 上1下2
8. **服务**（偶数）→ 上2下1

### 布局示例

**奇数主题域（上1下2）**：
```
        [节点1]
    [节点2] [节点3]
```

**偶数主题域（上2下1）**：
```
    [节点1] [节点2]
        [节点3]
```

### 修改的数据

```javascript
// 客户主题域（奇数，上1下2）
{ id: 'customer_crm', x: 35, y: 0 },      // 上行居中
{ id: 'customer_dw', x: 10, y: 70 },      // 下行左侧
{ id: 'customer_cache', x: 105, y: 70 },  // 下行右侧

// 订单主题域（偶数，上2下1）
{ id: 'order_oms', x: 360, y: 0 },        // 上行左侧
{ id: 'order_dw', x: 475, y: 0 },         // 上行右侧
{ id: 'order_realtime', x: 417, y: 70 },  // 下行居中
```

---

## 🔧 技术实现

### 1. 统一的拖拽系统

**核心函数**：
- `startDrag(event, node, nodeId, currentX, currentY, layerY)` - 开始拖拽
- `onDrag(event)` - 拖拽中
- `endDrag(event)` - 结束拖拽

**关键改进**：
- 添加 `layerY` 参数，支持所有层的节点
- 在 `endDrag()` 中自动识别节点类型（概念/主题域/逻辑/物理）
- 统一的点击检测逻辑（距离 < 5px）

### 2. 统一的尺寸调整系统

**核心函数**：
- `startResize(event, node, nodeId, currentX, currentY, currentWidth, currentHeight, layerY)` - 开始调整
- `onResize(event)` - 调整中
- `endResize(event)` - 结束调整

**关键改进**：
- 添加 `layerY` 参数，支持所有层的节点
- 在 `onResize()` 和 `endResize()` 中自动识别节点类型
- 统一的最小尺寸限制（60px × 40px）

### 3. 通用的连接线更新系统

**核心函数**：
- `updateAllConnectionLines(nodeId)` - 更新所有相关连接线
- `updateConnectionLinesForResize(nodeId, nodeX, nodeY, nodeWidth, nodeHeight)` - 调整尺寸时更新连接线

**支持的连接线类型**：
- ✅ 垂直连接线（概念→主题域、主题域→逻辑模型、逻辑模型→物理模型）
- ✅ 水平连接线（主题域之间）

**连接线标记**：
```javascript
// 垂直连接线
.attr('data-source', sourceId)
.attr('data-target', targetId)
.attr('data-source-x', x1)
.attr('data-source-y', y1)
.attr('data-target-x', x2)
.attr('data-target-y', y2)

// 水平连接线
.attr('data-source', sourceId)
.attr('data-target', targetId)
```

### 4. 自定义布局数据结构

**扩展后的数据结构**：
```javascript
customLayout = {
  // 概念模型层
  "conceptual": { x: 565, y: 0, width: 400, height: 70 },
  
  // 主题域层
  "customer": { x: 80, y: 0, width: 140, height: 80 },
  "order": { x: 420, y: 0, width: 140, height: 80 },
  
  // 逻辑模型层
  "customer_logical": { x: 80, y: 0, width: 140, height: 80 },
  "order_logical": { x: 420, y: 0, width: 140, height: 80 },
  
  // 物理模型层
  "customer_crm": { x: 35, y: 0, width: 90, height: 60 },
  "order_oms": { x: 360, y: 0, width: 90, height: 60 }
}
```

---

## 📝 详细修改清单

### 1. 物理模型层布局数据修改（第720-764行）

**修改内容**：
- 重新计算所有24个物理模型节点的坐标
- 按照奇偶规则排列节点
- 添加注释说明布局规则

### 2. 概念模型层绘制函数修改（第935-999行）

**修改内容**：
- 应用 `customLayout['conceptual']` 的位置和尺寸
- 添加拖拽事件监听
- 添加调整尺寸手柄
- 文字位置根据尺寸居中

### 3. 主题域层绘制函数修改（第1001-1071行）

**修改内容**：
- 应用 `customLayout[subject.id]` 的位置和尺寸
- 为每个主题域节点添加拖拽和尺寸调整事件
- 添加调整手柄
- 文字位置根据尺寸居中

### 4. 逻辑模型层绘制函数修改（第1073-1143行）

**修改内容**：
- 应用 `customLayout[logical.id]` 的位置和尺寸
- 为每个逻辑模型节点添加拖拽和尺寸调整事件
- 添加调整手柄
- 文字位置根据尺寸居中

### 5. 垂直连接线绘制函数修改（第1223-1325行）

**修改内容**：
- 为所有垂直连接线添加 `data-source` 和 `data-target` 属性
- 添加 `data-source-x/y` 和 `data-target-x/y` 属性
- 应用自定义布局计算连接点
- 支持三种垂直连接：概念→主题域、主题域→逻辑模型、逻辑模型→物理模型

### 6. 水平连接线绘制函数修改（第1327-1359行）

**修改内容**：
- 为所有水平连接线添加 `data-source` 和 `data-target` 属性
- 应用自定义布局计算连接点
- 支持主题域之间的水平连接

### 7. 拖拽函数修改（第1524-1645行）

**修改内容**：
- `startDrag()` 添加 `layerY` 参数
- `onDrag()` 调用 `updateAllConnectionLines()`
- `endDrag()` 支持所有层的节点类型识别

### 8. 通用连接线更新函数（第1647-1763行）

**新增函数**：
- `updateAllConnectionLines(nodeId)` - 替代旧的 `updateConnectionLines()`
- 支持所有层的节点
- 更新垂直和水平连接线

### 9. 尺寸调整函数修改（第1765-1918行）

**修改内容**：
- `startResize()` 添加 `layerY` 参数
- `onResize()` 支持所有层的节点类型识别
- `endResize()` 支持所有层的节点类型识别

### 10. 连接线调整更新函数修改（第1920-1988行）

**修改内容**：
- `updateConnectionLinesForResize()` 添加 `nodeHeight` 参数
- 更新垂直和水平连接线
- 支持所有层的节点

---

## 🧪 测试方法

### 1. 测试概念模型层
- 拖拽企业数据模型节点
- 调整节点尺寸
- 观察连接到主题域的连接线是否实时更新
- 点击节点查看详情

### 2. 测试主题域层
- 拖拽任意主题域节点
- 调整节点尺寸
- 观察垂直连接线（到逻辑模型）和水平连接线（到其他主题域）是否实时更新
- 点击节点查看详情

### 3. 测试逻辑模型层
- 拖拽任意逻辑模型节点
- 调整节点尺寸
- 观察连接到物理模型的连接线是否实时更新
- 点击节点查看详情

### 4. 测试物理模型层
- 验证新的布局规则（奇偶交替）
- 拖拽任意物理模型节点
- 调整节点尺寸
- 观察连接线是否实时更新
- 点击节点查看详情

### 5. 测试布局保存
- 拖动和调整各层的节点
- 刷新页面（F5）
- 验证所有自定义位置和尺寸保持不变

### 6. 测试重置布局
- 点击"重置布局"按钮
- 验证所有层的节点恢复默认位置和尺寸

---

## 🎨 技术亮点

1. **统一的交互系统** - 所有层使用相同的拖拽和尺寸调整逻辑
2. **智能节点识别** - 自动识别节点类型（概念/主题域/逻辑/物理）
3. **全面的连接线更新** - 支持垂直和水平连接线的实时更新
4. **灵活的布局规则** - 物理模型层支持奇偶交替布局
5. **完整的状态管理** - 所有层的位置和尺寸统一保存到localStorage
6. **优雅的代码复用** - 最大化复用现有的拖拽和尺寸调整代码

---

## 📊 默认尺寸和最小尺寸

| 层级 | 默认宽度 | 默认高度 | 最小宽度 | 最小高度 |
|------|----------|----------|----------|----------|
| 概念模型层 | 400px | 70px | 60px | 40px |
| 主题域层 | 140px | 80px | 60px | 40px |
| 逻辑模型层 | 140px | 80px | 60px | 40px |
| 物理模型层 | 90px | 60px | 60px | 40px |

---

**所有功能已完成！** 🎉 用户现在可以：
1. ✅ 拖拽和调整所有四层的节点
2. ✅ 所有连接线实时跟随节点移动
3. ✅ 物理模型层按奇偶规则排列
4. ✅ 布局自动保存，刷新后保持不变
5. ✅ 随时重置为默认布局

