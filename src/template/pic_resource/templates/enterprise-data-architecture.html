<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ä¼ä¸šæ•°æ®æ¶æ„ - DAMA Platform</title>
  <script src="https://d3js.org/d3.v7.min.js"></script>
  <style>
    /* ========== Reset & Base Styles ========== */
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    /* ========== Anthropic-inspired Design System ========== */
    :root {
      /* Colors - Warm Neutral Palette */
      --bg-primary: #FAF9F5;        /* Warm white background */
      --bg-secondary: #F0EEE6;      /* Light beige */
      --bg-tertiary: #E8E6DD;       /* Darker beige */
      --text-primary: #141413;      /* Deep black text */
      --text-secondary: #666666;    /* Gray secondary text */
      --text-tertiary: #999999;     /* Light gray text */
      --border-color: #E5E5E5;      /* Light gray border */
      --button-bg: #141413;         /* Black button */
      --button-text: #FAF9F5;       /* White button text */
      --primary-color: #2563eb;     /* Blue accent */
      --primary-light: #dbeafe;     /* Light blue */

      /* Typography - Anthropic-style */
      --font-heading: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
      --font-body: Georgia, "Times New Roman", Times, serif;

      /* Font Sizes - Large & Readable */
      --font-size-sm: 14px;
      --font-size-base: 16px;
      --font-size-lg: 18px;
      --font-size-xl: 20px;
      --font-size-2xl: 24px;
      --font-size-3xl: 28px;

      /* Spacing */
      --spacing-xs: 8px;
      --spacing-sm: 12px;
      --spacing-md: 20px;
      --spacing-lg: 32px;
      --spacing-xl: 48px;

      /* Border Radius */
      --radius-sm: 8px;
      --radius-md: 12px;
      --radius-lg: 16px;

      /* Shadows */
      --shadow-sm: 0 1px 3px rgba(0, 0, 0, 0.08);
      --shadow-md: 0 4px 12px rgba(0, 0, 0, 0.1);
      --shadow-lg: 0 8px 24px rgba(0, 0, 0, 0.12);
    }

    body {
      font-family: var(--font-body);
      font-size: var(--font-size-base);
      line-height: 1.6;
      color: var(--text-primary);
      background-color: var(--bg-primary);
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }

    /* ========== Header / Navigation ========== */
    .header {
      background-color: var(--bg-secondary);
      padding: var(--spacing-sm) var(--spacing-lg);
      position: sticky;
      top: 0;
      z-index: 100;
      border-bottom: 1px solid var(--border-color);
    }

    .header-container {
      max-width: 1800px;
      margin: 0 auto;
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: var(--spacing-lg);
    }

    .logo-container {
      display: flex;
      align-items: center;
      gap: var(--spacing-sm);
      text-decoration: none;
      color: var(--text-primary);
      flex-shrink: 0;
    }

    .logo-icon {
      width: 32px;
      height: 32px;
      filter: grayscale(100%) brightness(0);
    }

    .logo-text {
      font-family: var(--font-heading);
      font-size: var(--font-size-xl);
      font-weight: 500;
      letter-spacing: -0.5px;
    }

    .header-nav {
      display: flex;
      gap: var(--spacing-xs);
      flex: 1;
      justify-content: center;
    }

    .nav-link {
      display: flex;
      align-items: center;
      gap: var(--spacing-xs);
      padding: var(--spacing-xs) var(--spacing-sm);
      font-family: var(--font-heading);
      font-size: var(--font-size-sm);
      color: var(--text-secondary);
      text-decoration: none;
      border-radius: var(--radius-sm);
      transition: all 0.2s;
      white-space: nowrap;
    }

    .nav-link:hover {
      background-color: var(--bg-tertiary);
      color: var(--text-primary);
    }

    .nav-link.active {
      background-color: var(--button-bg);
      color: var(--button-text);
      font-weight: 500;
    }

    .nav-icon {
      width: 18px;
      height: 18px;
      opacity: 0.7;
    }

    .nav-link.active .nav-icon {
      opacity: 1;
      filter: brightness(0) invert(1);
    }

    .header-actions {
      display: flex;
      gap: var(--spacing-sm);
      align-items: center;
      flex-shrink: 0;
    }

    .btn-header {
      padding: var(--spacing-xs) var(--spacing-md);
      font-family: var(--font-heading);
      font-size: var(--font-size-sm);
      font-weight: 500;
      color: var(--text-primary);
      background: var(--bg-primary);
      border: 1px solid var(--border-color);
      border-radius: var(--radius-sm);
      cursor: pointer;
      transition: all 0.2s;
      white-space: nowrap;
    }

    .btn-header:hover {
      background-color: var(--bg-tertiary);
    }

    .btn-header.btn-primary {
      background-color: var(--button-bg);
      color: var(--button-text);
      border-color: var(--button-bg);
    }

    .btn-header.btn-primary:hover {
      opacity: 0.85;
    }

    /* ========== Architecture Workspace ========== */
    .architecture-workspace {
      display: grid;
      grid-template-columns: 280px 1fr 380px;
      height: calc(100vh - 80px);
      gap: 0;
    }

    .layer-control {
      background: var(--bg-primary);
      border-right: 1px solid var(--border-color);
      overflow-y: auto;
      padding: var(--spacing-lg);
    }

    .architecture-canvas {
      background: var(--bg-secondary);
      position: relative;
      overflow: hidden;
    }

    .model-panel {
      background: var(--bg-primary);
      border-left: 1px solid var(--border-color);
      overflow-y: auto;
      padding: var(--spacing-lg);
    }

    #architecture-svg {
      width: 100%;
      height: 100%;
    }

    .layer-item {
      padding: var(--spacing-md);
      background: var(--bg-secondary);
      border-radius: var(--radius-md);
      margin-bottom: var(--spacing-sm);
      cursor: pointer;
      transition: all 0.2s;
      border: 2px solid transparent;
      font-family: var(--font-heading);
    }

    .layer-item:hover {
      background: var(--bg-tertiary);
      border-color: var(--border-color);
    }

    .layer-item.active {
      background: var(--button-bg);
      color: var(--button-text);
      font-weight: 500;
      border-color: var(--button-bg);
    }

    .layer-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: var(--spacing-xs);
    }

    .layer-icon {
      width: 20px;
      height: 20px;
      margin-right: var(--spacing-xs);
      opacity: 0.7;
    }

    .layer-item.active .layer-icon {
      opacity: 1;
      filter: brightness(0) invert(1);
    }

    .layer-toggle {
      width: 20px;
      height: 20px;
      border-radius: 4px;
      border: 2px solid currentColor;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: var(--font-size-sm);
    }

    .layer-description {
      font-size: var(--font-size-sm);
      opacity: 0.7;
      margin-top: var(--spacing-xs);
      font-family: var(--font-body);
    }

    /* æ¨¡å‹å±‚æ ·å¼ */
    .model-layer-group {
      fill: var(--bg-primary);
      stroke: var(--border-color);
      stroke-width: 2px;
      rx: 12px;
    }

    .model-layer-label {
      font-size: 18px;
      font-weight: 500;
      font-family: var(--font-heading);
      fill: var(--text-primary);
    }

    /* æ¨¡å‹èŠ‚ç‚¹æ ·å¼ */
    .model-node {
      fill: var(--bg-primary);
      stroke: var(--text-primary);
      stroke-width: 2px;
      rx: 8px;
      cursor: grab;
      transition: all 0.2s;
    }

    .model-node:hover {
      fill: var(--bg-tertiary);
      stroke-width: 2.5px;
      filter: drop-shadow(0 4px 12px rgba(0,0,0,0.08));
    }

    .model-node.selected {
      fill: var(--button-bg);
      stroke: var(--button-bg);
      stroke-width: 3px;
    }

    .model-node.dragging {
      cursor: grabbing;
      opacity: 0.7;
      filter: drop-shadow(0 8px 16px rgba(0, 0, 0, 0.3));
    }

    .model-group.dragging {
      cursor: grabbing;
    }

    /* è°ƒæ•´å°ºå¯¸æ‰‹æŸ„ */
    .resize-handle {
      fill: var(--button-bg);
      stroke: var(--bg-primary);
      stroke-width: 2px;
      cursor: nwse-resize;
      opacity: 0;
      transition: opacity 0.2s;
    }

    .model-group:hover .resize-handle {
      opacity: 0.8;
    }

    .resize-handle:hover {
      opacity: 1;
      fill: var(--text-primary);
    }

    .resize-handle.resizing {
      opacity: 1;
    }

    .model-text {
      font-size: 14px;
      font-weight: 500;
      font-family: var(--font-heading);
      fill: var(--text-primary);
      text-anchor: middle;
      pointer-events: none;
    }

    .model-text.selected {
      fill: var(--button-text);
    }

    .model-count {
      font-size: 12px;
      font-family: var(--font-heading);
      fill: var(--text-secondary);
      text-anchor: middle;
      pointer-events: none;
    }

    .model-count.selected {
      fill: rgba(250, 249, 245, 0.9);
    }

    /* å…³ç³»çº¿æ ·å¼ */
    .vertical-relation {
      stroke: var(--text-primary);
      stroke-width: 2px;
      fill: none;
      marker-end: url(#arrow-down);
      opacity: 0.3;
    }

    .horizontal-relation {
      stroke: var(--text-secondary);
      stroke-width: 1.5px;
      fill: none;
      marker-end: url(#arrow-right);
      opacity: 0.3;
      stroke-dasharray: 5,5;
    }

    .zoom-controls {
      position: absolute;
      bottom: var(--spacing-md);
      right: var(--spacing-md);
      display: flex;
      flex-direction: column;
      gap: var(--spacing-xs);
      background: var(--bg-primary);
      border: 1px solid var(--border-color);
      border-radius: var(--radius-md);
      padding: var(--spacing-xs);
      box-shadow: var(--shadow-md);
    }

    .zoom-btn {
      width: 40px;
      height: 40px;
      border: none;
      background: var(--bg-secondary);
      border-radius: var(--radius-sm);
      cursor: pointer;
      font-family: var(--font-heading);
      font-size: 20px;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--text-primary);
    }

    .zoom-btn:hover {
      background: var(--button-bg);
      color: var(--button-text);
    }

    .model-detail {
      background: var(--bg-secondary);
      border-radius: var(--radius-md);
      padding: var(--spacing-lg);
      margin-bottom: var(--spacing-lg);
    }

    .model-detail h4 {
      font-size: var(--font-size-xl);
      font-weight: 500;
      font-family: var(--font-heading);
      margin-bottom: var(--spacing-md);
      color: var(--text-primary);
    }

    .detail-section {
      margin-bottom: var(--spacing-md);
    }

    .detail-section:last-child {
      margin-bottom: 0;
    }

    .detail-section-title {
      font-size: var(--font-size-sm);
      font-weight: 500;
      font-family: var(--font-heading);
      color: var(--text-secondary);
      margin-bottom: var(--spacing-xs);
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .detail-row {
      display: flex;
      padding: var(--spacing-sm) 0;
      border-bottom: 1px solid var(--border-color);
      font-size: var(--font-size-base);
    }

    .detail-row:last-child {
      border-bottom: none;
    }

    .detail-label {
      flex: 0 0 120px;
      color: var(--text-secondary);
      font-weight: 500;
      font-family: var(--font-heading);
    }

    .detail-value {
      flex: 1;
      color: var(--text-primary);
      font-family: var(--font-body);
    }

    .entity-list {
      display: flex;
      flex-direction: column;
      gap: var(--spacing-sm);
      margin-top: var(--spacing-sm);
    }

    .entity-item {
      padding: var(--spacing-md);
      background: var(--bg-primary);
      border-radius: var(--radius-sm);
      font-size: var(--font-size-base);
      font-family: var(--font-body);
      border-left: 3px solid var(--text-primary);
      transition: all 0.2s;
      cursor: pointer;
    }

    .entity-item:hover {
      background: var(--bg-tertiary);
      transform: translateX(4px);
    }

    .stats-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: var(--spacing-sm);
      margin-top: var(--spacing-sm);
    }

    .stat-card {
      padding: var(--spacing-md);
      background: var(--bg-primary);
      border-radius: var(--radius-sm);
      text-align: center;
    }

    .stat-value {
      font-size: var(--font-size-3xl);
      font-weight: 500;
      font-family: var(--font-heading);
      color: var(--primary-color);
    }

    .stat-label {
      font-size: var(--font-size-sm);
      font-family: var(--font-heading);
      color: var(--text-secondary);
      margin-top: var(--spacing-xs);
    }
  </style>
</head>
<body>
  <!-- Header / Navigation -->
  <header class="header">
    <div class="header-container">
      <a href="index.html" class="logo-container">
        <img src="../../icon/hdlogo.com-measurable-data-token-mdt.svg" alt="DAMA Logo" class="logo-icon">
        <span class="logo-text">DAMA Platform</span>
      </a>

      <nav class="header-nav">
        <a href="index.html" class="nav-link">
          <img src="../../icon/Emoji_instead/dashboard-4.svg" alt="é¦–é¡µ" class="nav-icon">
          <span>é¦–é¡µ</span>
        </a>
        <a href="modeling.html" class="nav-link">
          <img src="../../icon/Emoji_instead/data.svg" alt="æ•°æ®å»ºæ¨¡" class="nav-icon">
          <span>æ•°æ®å»ºæ¨¡</span>
        </a>
        <a href="metadata.html" class="nav-link">
          <img src="../../icon/Emoji_instead/database-3.svg" alt="å…ƒæ•°æ®ç®¡ç†" class="nav-icon">
          <span>å…ƒæ•°æ®ç®¡ç†</span>
        </a>
        <a href="lineage.html" class="nav-link">
          <img src="../../icon/Emoji_instead/code-fork-3.svg" alt="æ•°æ®è¡€ç¼˜" class="nav-icon">
          <span>æ•°æ®è¡€ç¼˜</span>
        </a>
        <a href="data-flow-matrix.html" class="nav-link">
          <img src="../../icon/Emoji_instead/refresh.svg" alt="æ•°æ®æµçŸ©é˜µ" class="nav-icon">
          <span>æ•°æ®æµçŸ©é˜µ</span>
        </a>
        <a href="enterprise-data-architecture.html" class="nav-link active">
          <img src="../../icon/Emoji_instead/ic_enterprice.svg" alt="ä¼ä¸šæ¶æ„" class="nav-icon">
          <span>ä¼ä¸šæ¶æ„</span>
        </a>
        <a href="ai-assistant.html" class="nav-link">
          <img src="../../icon/Emoji_instead/robot.svg" alt="AIåŠ©æ‰‹" class="nav-icon">
          <span>AIåŠ©æ‰‹</span>
        </a>
      </nav>

      <div class="header-actions">
        <button class="btn-header" onclick="resetLayout()">é‡ç½®å¸ƒå±€</button>
        <button class="btn-header" onclick="exportDiagram()">å¯¼å‡ºPNG</button>
        <button class="btn-header btn-primary" onclick="optimizeArchitecture()">AIä¼˜åŒ–å»ºè®®</button>
      </div>
    </div>
  </header>

  <!-- Architecture Workspace -->
  <div class="architecture-workspace">
    <!-- Layer Control -->
    <div class="layer-control">
      <h3 style="margin-bottom: var(--spacing-lg); font-size: var(--font-size-2xl); font-weight: 500; font-family: var(--font-heading);">æ¨¡å‹å±‚æ¬¡</h3>

      <div class="layer-item active" onclick="toggleLayer(this, 'conceptual')">
        <div class="layer-header">
          <span><img src="../../icon/Emoji_instead/dashboard-4.svg" alt="æ¦‚å¿µæ¨¡å‹" class="layer-icon">æ¦‚å¿µæ¨¡å‹å±‚</span>
          <div class="layer-toggle">âœ“</div>
        </div>
        <div class="layer-description">ä¼ä¸šçº§é«˜å±‚æ¬¡æŠ½è±¡</div>
      </div>

      <div class="layer-item active" onclick="toggleLayer(this, 'subject')">
        <div class="layer-header">
          <span><img src="../../icon/Emoji_instead/database-3.svg" alt="ä¸»é¢˜åŸŸ" class="layer-icon">ä¸»é¢˜åŸŸå±‚</span>
          <div class="layer-toggle">âœ“</div>
        </div>
        <div class="layer-description">ä¸šåŠ¡ä¸»é¢˜åŸŸæ¨¡å‹ï¼ˆ12-20ä¸ªï¼‰</div>
      </div>

      <div class="layer-item active" onclick="toggleLayer(this, 'logical')">
        <div class="layer-header">
          <span><img src="../../icon/Emoji_instead/code-12.svg" alt="é€»è¾‘æ¨¡å‹" class="layer-icon">é€»è¾‘æ¨¡å‹å±‚</span>
          <div class="layer-toggle">âœ“</div>
        </div>
        <div class="layer-description">3NFè§„èŒƒåŒ–æ¨¡å‹</div>
      </div>

      <div class="layer-item active" onclick="toggleLayer(this, 'physical')">
        <div class="layer-header">
          <span><img src="../../icon/Emoji_instead/cpu-6.svg" alt="ç‰©ç†æ¨¡å‹" class="layer-icon">ç‰©ç†æ¨¡å‹å±‚</span>
          <div class="layer-toggle">âœ“</div>
        </div>
        <div class="layer-description">å®é™…æ•°æ®åº“è¡¨ç»“æ„</div>
      </div>

      <div style="margin-top: var(--spacing-lg); padding-top: var(--spacing-lg); border-top: 1px solid var(--border-color);">
        <h4 style="font-size: var(--font-size-lg); margin-bottom: var(--spacing-md); font-weight: 500; font-family: var(--font-heading);">æ¶æ„ç»Ÿè®¡</h4>
        <div style="font-size: var(--font-size-base); font-family: var(--font-body); color: var(--text-secondary); line-height: 1.8;">
          <div style="display: flex; justify-content: space-between; margin-bottom: var(--spacing-xs);">
            <span>ä¸»é¢˜åŸŸ:</span>
            <strong style="color: var(--text-primary); font-family: var(--font-heading);">15</strong>
          </div>
          <div style="display: flex; justify-content: space-between; margin-bottom: var(--spacing-xs);">
            <span>é€»è¾‘æ¨¡å‹:</span>
            <strong style="color: var(--text-primary); font-family: var(--font-heading);">15</strong>
          </div>
          <div style="display: flex; justify-content: space-between; margin-bottom: var(--spacing-xs);">
            <span>ç‰©ç†æ¨¡å‹:</span>
            <strong style="color: var(--text-primary); font-family: var(--font-heading);">45</strong>
          </div>
          <div style="display: flex; justify-content: space-between;">
            <span>æ€»å®ä½“æ•°:</span>
            <strong style="color: var(--text-primary); font-family: var(--font-heading);">750+</strong>
          </div>
        </div>
      </div>
    </div>

    <!-- Architecture Canvas -->
    <div class="architecture-canvas">
      <svg id="architecture-svg">
        <defs>
          <!-- å‘ä¸‹ç®­å¤´ï¼ˆå‚ç›´å…³ç³»ï¼‰- ç®­å¤´æŒ‡å‘å³ä¾§ï¼Œorient="auto"ä¼šè‡ªåŠ¨æ—‹è½¬ä½¿å…¶å‚ç›´äºè·¯å¾„ -->
          <marker id="arrow-down" viewBox="0 0 10 10" refX="10" refY="5"
                  markerWidth="4" markerHeight="4" orient="auto">
            <polygon points="0 0, 10 5, 0 10" fill="#141413" />
          </marker>
          <!-- å‘å³ç®­å¤´ï¼ˆæ¨ªå‘å…³ç³»ï¼‰- ç®­å¤´æŒ‡å‘å³ä¾§ï¼Œorient="auto"ä¼šè‡ªåŠ¨æ—‹è½¬ä½¿å…¶å‚ç›´äºè·¯å¾„ -->
          <marker id="arrow-right" viewBox="0 0 10 6" refX="10" refY="3"
                  markerWidth="4" markerHeight="4" orient="auto">
            <polygon points="0 0, 10 3, 0 6" fill="#666666" />
          </marker>
        </defs>
      </svg>

      <!-- Zoom Controls -->
      <div class="zoom-controls">
        <button class="zoom-btn" onclick="zoomIn()" title="æ”¾å¤§">+</button>
        <button class="zoom-btn" onclick="zoomOut()" title="ç¼©å°">âˆ’</button>
        <button class="zoom-btn" onclick="resetZoom()" title="é‡ç½®">âŠ™</button>
      </div>
    </div>

    <!-- Model Panel -->
    <div class="model-panel">
      <h3 style="margin-bottom: var(--spacing-lg); font-size: var(--font-size-2xl); font-weight: 500; font-family: var(--font-heading);">æ¨¡å‹è¯¦æƒ…</h3>

      <div id="model-detail-content">
        <div style="text-align: center; padding: var(--spacing-xl) var(--spacing-md); color: var(--text-tertiary);">
          <img src="../../icon/Emoji_instead/data.svg" alt="æ•°æ®" style="width: 64px; height: 64px; opacity: 0.3; margin-bottom: var(--spacing-md);">
          <p style="font-size: var(--font-size-base); font-family: var(--font-body);">ç‚¹å‡»æ¨¡å‹èŠ‚ç‚¹æŸ¥çœ‹è¯¦ç»†ä¿¡æ¯</p>
        </div>
      </div>
    </div>
  </div>

  <script>
    // DMBOK2 ä¼ä¸šæ•°æ®æ¨¡å‹æ¶æ„æ•°æ®
    const dataModelArchitecture = {
      // æ¦‚å¿µæ¨¡å‹å±‚ï¼ˆæœ€é¡¶å±‚ï¼‰
      conceptual: {
        id: 'conceptual',
        name: 'ä¼ä¸šæ•°æ®æ¨¡å‹',
        description: 'ä¼ä¸šçº§é«˜å±‚æ¬¡æ•°æ®æŠ½è±¡ï¼Œå®šä¹‰æ ¸å¿ƒä¸šåŠ¡æ¦‚å¿µåŠå…¶å…³ç³»',
        y: 50,
        height: 100,
        entities: ['å®¢æˆ·', 'äº§å“', 'è®¢å•', 'å‘˜å·¥', 'ä¾›åº”å•†', 'è´¢åŠ¡', 'åº“å­˜', 'è¥é”€']
      },

      // ä¸»é¢˜åŸŸå±‚ï¼ˆ8ä¸ªä¸»é¢˜åŸŸï¼‰- èŠ‚ç‚¹å®½åº¦140pxï¼Œé—´è·30pxï¼Œæ€»å®½åº¦=(140+30)*8-30=1330px
      subjects: [
        { id: 'customer', name: 'å®¢æˆ·ä¸»é¢˜åŸŸ', entityCount: 52, x: 80, description: 'å®¢æˆ·ä¿¡æ¯ã€å®¢æˆ·å…³ç³»ã€å®¢æˆ·è¡Œä¸º' },
        { id: 'product', name: 'äº§å“ä¸»é¢˜åŸŸ', entityCount: 48, x: 250, description: 'äº§å“ä¿¡æ¯ã€äº§å“åˆ†ç±»ã€äº§å“å±æ€§' },
        { id: 'order', name: 'è®¢å•ä¸»é¢˜åŸŸ', entityCount: 65, x: 420, description: 'è®¢å•ç®¡ç†ã€è®¢å•æ˜ç»†ã€è®¢å•çŠ¶æ€' },
        { id: 'finance', name: 'è´¢åŠ¡ä¸»é¢˜åŸŸ', entityCount: 58, x: 590, description: 'è´¢åŠ¡æ ¸ç®—ã€æˆæœ¬ç®¡ç†ã€èµ„é‡‘æµ' },
        { id: 'hr', name: 'äººåŠ›èµ„æºä¸»é¢˜åŸŸ', entityCount: 45, x: 760, description: 'å‘˜å·¥ä¿¡æ¯ã€ç»„ç»‡æ¶æ„ã€è–ªé…¬ç»©æ•ˆ' },
        { id: 'supply', name: 'ä¾›åº”é“¾ä¸»é¢˜åŸŸ', entityCount: 55, x: 930, description: 'ä¾›åº”å•†ã€é‡‡è´­ã€åº“å­˜ç®¡ç†' },
        { id: 'marketing', name: 'è¥é”€ä¸»é¢˜åŸŸ', entityCount: 42, x: 1100, description: 'è¥é”€æ´»åŠ¨ã€æ¸ é“ç®¡ç†ã€æ•ˆæœåˆ†æ' },
        { id: 'service', name: 'æœåŠ¡ä¸»é¢˜åŸŸ', entityCount: 38, x: 1270, description: 'å®¢æˆ·æœåŠ¡ã€å·¥å•ç®¡ç†ã€æœåŠ¡è´¨é‡' }
      ],

      // é€»è¾‘æ¨¡å‹å±‚ï¼ˆæ¯ä¸ªä¸»é¢˜åŸŸå¯¹åº”ä¸€ä¸ªé€»è¾‘æ¨¡å‹ï¼‰- ä¸ä¸»é¢˜åŸŸå¯¹é½
      logical: [
        { id: 'customer_logical', subjectId: 'customer', name: 'å®¢æˆ·é€»è¾‘æ¨¡å‹', entityCount: 52, x: 80, normalization: '3NF' },
        { id: 'product_logical', subjectId: 'product', name: 'äº§å“é€»è¾‘æ¨¡å‹', entityCount: 48, x: 250, normalization: '3NF' },
        { id: 'order_logical', subjectId: 'order', name: 'è®¢å•é€»è¾‘æ¨¡å‹', entityCount: 65, x: 420, normalization: '3NF' },
        { id: 'finance_logical', subjectId: 'finance', name: 'è´¢åŠ¡é€»è¾‘æ¨¡å‹', entityCount: 58, x: 590, normalization: '3NF' },
        { id: 'hr_logical', subjectId: 'hr', name: 'äººåŠ›èµ„æºé€»è¾‘æ¨¡å‹', entityCount: 45, x: 760, normalization: '3NF' },
        { id: 'supply_logical', subjectId: 'supply', name: 'ä¾›åº”é“¾é€»è¾‘æ¨¡å‹', entityCount: 55, x: 930, normalization: '3NF' },
        { id: 'marketing_logical', subjectId: 'marketing', name: 'è¥é”€é€»è¾‘æ¨¡å‹', entityCount: 42, x: 1100, normalization: '3NF' },
        { id: 'service_logical', subjectId: 'service', name: 'æœåŠ¡é€»è¾‘æ¨¡å‹', entityCount: 38, x: 1270, normalization: '3NF' }
      ],

      // ç‰©ç†æ¨¡å‹å±‚ï¼ˆæ¯ä¸ªé€»è¾‘æ¨¡å‹å¯¹åº”3ä¸ªç‰©ç†æ¨¡å‹ï¼‰
      // å¥‡æ•°ä¸»é¢˜åŸŸï¼ˆå®¢æˆ·ã€äº§å“ã€è´¢åŠ¡ã€è¥é”€ï¼‰ï¼šä¸Š1ä¸‹2
      // å¶æ•°ä¸»é¢˜åŸŸï¼ˆè®¢å•ã€ä¾›åº”é“¾ã€äººåŠ›èµ„æºã€æœåŠ¡ï¼‰ï¼šä¸Š2ä¸‹1
      // èŠ‚ç‚¹å®½åº¦90pxï¼Œé«˜åº¦60pxï¼Œæ°´å¹³é—´è·25pxï¼Œå‚ç›´é—´è·10px
      physical: [
        // å®¢æˆ·ä¸»é¢˜åŸŸç‰©ç†æ¨¡å‹ï¼ˆå¥‡æ•°ï¼Œä¸Š1ä¸‹2ï¼Œå±…ä¸­å¯¹é½x=80ï¼‰
        { id: 'customer_crm', logicalId: 'customer_logical', name: 'CRMæ•°æ®åº“', x: 35, y: 0, tableCount: 18, platform: 'PostgreSQL' },
        { id: 'customer_dw', logicalId: 'customer_logical', name: 'å®¢æˆ·æ•°ä»“', x: 10, y: 70, tableCount: 22, platform: 'Hive' },
        { id: 'customer_cache', logicalId: 'customer_logical', name: 'å®¢æˆ·ç¼“å­˜', x: 105, y: 70, tableCount: 12, platform: 'Redis' },

        // äº§å“ä¸»é¢˜åŸŸç‰©ç†æ¨¡å‹ï¼ˆå¥‡æ•°ï¼Œä¸Š1ä¸‹2ï¼Œå±…ä¸­å¯¹é½x=250ï¼‰
        { id: 'product_pim', logicalId: 'product_logical', name: 'PIMç³»ç»Ÿ', x: 205, y: 0, tableCount: 16, platform: 'MySQL' },
        { id: 'product_dw', logicalId: 'product_logical', name: 'äº§å“æ•°ä»“', x: 180, y: 70, tableCount: 20, platform: 'Hive' },
        { id: 'product_search', logicalId: 'product_logical', name: 'äº§å“æœç´¢', x: 275, y: 70, tableCount: 12, platform: 'ES' },

        // è®¢å•ä¸»é¢˜åŸŸç‰©ç†æ¨¡å‹ï¼ˆå¶æ•°ï¼Œä¸Š2ä¸‹1ï¼Œå±…ä¸­å¯¹é½x=420ï¼‰
        { id: 'order_oms', logicalId: 'order_logical', name: 'OMSç³»ç»Ÿ', x: 360, y: 0, tableCount: 22, platform: 'PostgreSQL' },
        { id: 'order_dw', logicalId: 'order_logical', name: 'è®¢å•æ•°ä»“', x: 475, y: 0, tableCount: 28, platform: 'Hive' },
        { id: 'order_realtime', logicalId: 'order_logical', name: 'å®æ—¶è®¢å•', x: 417, y: 70, tableCount: 15, platform: 'Kafka' },

        // è´¢åŠ¡ä¸»é¢˜åŸŸç‰©ç†æ¨¡å‹ï¼ˆå¥‡æ•°ï¼Œä¸Š1ä¸‹2ï¼Œå±…ä¸­å¯¹é½x=590ï¼‰
        { id: 'finance_erp', logicalId: 'finance_logical', name: 'ERPè´¢åŠ¡', x: 545, y: 0, tableCount: 20, platform: 'Oracle' },
        { id: 'finance_dw', logicalId: 'finance_logical', name: 'è´¢åŠ¡æ•°ä»“', x: 520, y: 70, tableCount: 24, platform: 'Hive' },
        { id: 'finance_report', logicalId: 'finance_logical', name: 'è´¢åŠ¡æŠ¥è¡¨', x: 615, y: 70, tableCount: 14, platform: 'PostgreSQL' },

        // äººåŠ›èµ„æºä¸»é¢˜åŸŸç‰©ç†æ¨¡å‹ï¼ˆå¶æ•°ï¼Œä¸Š2ä¸‹1ï¼Œå±…ä¸­å¯¹é½x=760ï¼‰
        { id: 'hr_hris', logicalId: 'hr_logical', name: 'HRISç³»ç»Ÿ', x: 700, y: 0, tableCount: 15, platform: 'MySQL' },
        { id: 'hr_dw', logicalId: 'hr_logical', name: 'HRæ•°ä»“', x: 815, y: 0, tableCount: 18, platform: 'Hive' },
        { id: 'hr_analytics', logicalId: 'hr_logical', name: 'HRåˆ†æ', x: 757, y: 70, tableCount: 12, platform: 'ClickHouse' },

        // ä¾›åº”é“¾ä¸»é¢˜åŸŸç‰©ç†æ¨¡å‹ï¼ˆå¶æ•°ï¼Œä¸Š2ä¸‹1ï¼Œå±…ä¸­å¯¹é½x=930ï¼‰
        { id: 'supply_scm', logicalId: 'supply_logical', name: 'SCMç³»ç»Ÿ', x: 870, y: 0, tableCount: 19, platform: 'PostgreSQL' },
        { id: 'supply_dw', logicalId: 'supply_logical', name: 'ä¾›åº”é“¾æ•°ä»“', x: 985, y: 0, tableCount: 23, platform: 'Hive' },
        { id: 'supply_wms', logicalId: 'supply_logical', name: 'WMSç³»ç»Ÿ', x: 927, y: 70, tableCount: 13, platform: 'MySQL' },

        // è¥é”€ä¸»é¢˜åŸŸç‰©ç†æ¨¡å‹ï¼ˆå¥‡æ•°ï¼Œä¸Š1ä¸‹2ï¼Œå±…ä¸­å¯¹é½x=1100ï¼‰
        { id: 'marketing_ma', logicalId: 'marketing_logical', name: 'MAå¹³å°', x: 1055, y: 0, tableCount: 14, platform: 'MongoDB' },
        { id: 'marketing_dw', logicalId: 'marketing_logical', name: 'è¥é”€æ•°ä»“', x: 1030, y: 70, tableCount: 18, platform: 'Hive' },
        { id: 'marketing_cdp', logicalId: 'marketing_logical', name: 'CDPå¹³å°', x: 1125, y: 70, tableCount: 10, platform: 'PostgreSQL' },

        // æœåŠ¡ä¸»é¢˜åŸŸç‰©ç†æ¨¡å‹ï¼ˆå¶æ•°ï¼Œä¸Š2ä¸‹1ï¼Œå±…ä¸­å¯¹é½x=1270ï¼‰
        { id: 'service_crm', logicalId: 'service_logical', name: 'æœåŠ¡CRM', x: 1210, y: 0, tableCount: 13, platform: 'MySQL' },
        { id: 'service_dw', logicalId: 'service_logical', name: 'æœåŠ¡æ•°ä»“', x: 1325, y: 0, tableCount: 16, platform: 'Hive' },
        { id: 'service_ticket', logicalId: 'service_logical', name: 'å·¥å•ç³»ç»Ÿ', x: 1267, y: 70, tableCount: 9, platform: 'PostgreSQL' }
      ],

      // æ¨ªå‘å…³ç³»ï¼ˆä¸»é¢˜åŸŸä¹‹é—´çš„å…³è”ï¼‰
      horizontalRelations: [
        { from: 'customer', to: 'order' },
        { from: 'order', to: 'product' },
        { from: 'order', to: 'finance' },
        { from: 'customer', to: 'marketing' },
        { from: 'customer', to: 'service' },
        { from: 'product', to: 'supply' },
        { from: 'hr', to: 'finance' }
      ]
    };

    let svg, g, zoom;
    let selectedModel = null;
    let visibleLayers = new Set(['conceptual', 'subject', 'logical', 'physical']);

    // æ‹–æ‹½çŠ¶æ€ç®¡ç†
    const dragState = {
      isDragging: false,
      currentNode: null,
      currentNodeId: null,
      startX: 0,
      startY: 0,
      offsetX: 0,
      offsetY: 0,
      layerY: 0 // ç‰©ç†å±‚çš„Yåæ ‡
    };

    // è°ƒæ•´å°ºå¯¸çŠ¶æ€ç®¡ç†
    const resizeState = {
      isResizing: false,
      currentNode: null,
      currentNodeId: null,
      startX: 0,
      startY: 0,
      startWidth: 0,
      startHeight: 0,
      minWidth: 60,
      minHeight: 40
    };

    // å­˜å‚¨ç”¨æˆ·è‡ªå®šä¹‰çš„å¸ƒå±€ï¼ˆåŒ…æ‹¬ä½ç½®å’Œå°ºå¯¸ï¼‰
    let customLayout = {};

    // åŠ¨æ€è®¡ç®—å±‚é«˜åº¦çš„è¾…åŠ©å‡½æ•°
    function calculateLayerHeight(layerType) {
      if (layerType === 'conceptual') {
        return 100; // æ¦‚å¿µå±‚å›ºå®šé«˜åº¦
      } else if (layerType === 'subject' || layerType === 'logical') {
        return 140; // ä¸»é¢˜åŸŸå’Œé€»è¾‘å±‚å›ºå®šé«˜åº¦
      } else if (layerType === 'physical') {
        // ç‰©ç†å±‚éœ€è¦å®¹çº³ä¸Šä¸‹ä¸¤è¡Œï¼šé¡¶éƒ¨åç§»50 + ä¸Šè¡Œ60 + é—´è·10 + ä¸‹è¡Œ60 + åº•éƒ¨padding20
        return 200;
      }
      return 140;
    }

    // è®¡ç®—æ•´ä¸ªç”»å¸ƒçš„å°ºå¯¸
    function calculateCanvasSize() {
      const width = 1560; // å®¹çº³æ‰€æœ‰èŠ‚ç‚¹çš„å®½åº¦ï¼ˆ1500å†…å®¹ + 30å·¦è¾¹è· + 30å³è¾¹è·ï¼‰
      let height = 50; // é¡¶éƒ¨è¾¹è·

      if (visibleLayers.has('conceptual')) {
        height += calculateLayerHeight('conceptual') + 50; // å±‚é«˜åº¦ + å±‚é—´è·
      }
      if (visibleLayers.has('subject')) {
        height += calculateLayerHeight('subject') + 60;
      }
      if (visibleLayers.has('logical')) {
        height += calculateLayerHeight('logical') + 60;
      }
      if (visibleLayers.has('physical')) {
        height += calculateLayerHeight('physical') + 50;
      }

      return { width, height };
    }

    // æ›´æ–°SVGçš„viewBoxä»¥é€‚åº”å†…å®¹
    function updateSVGViewBox() {
      const { width, height } = calculateCanvasSize();
      svg.attr('viewBox', `0 0 ${width} ${height}`)
         .attr('preserveAspectRatio', 'xMidYMid meet');
    }

    function initArchitecture() {
      svg = d3.select('#architecture-svg');
      const width = svg.node().getBoundingClientRect().width;
      const height = svg.node().getBoundingClientRect().height;

      zoom = d3.zoom()
        .scaleExtent([0.4, 2.5])
        .on('zoom', (event) => {
          g.attr('transform', event.transform);
        });

      svg.call(zoom);
      g = svg.append('g');

      // è®¾ç½®åˆå§‹viewBox
      updateSVGViewBox();

      renderArchitecture();
    }

    function renderArchitecture() {
      g.selectAll('*').remove();

      // åŠ¨æ€è®¡ç®—æ¯å±‚çš„Yåæ ‡å’Œé«˜åº¦
      let currentY = 50; // é¡¶éƒ¨è¾¹è·
      const layerY = {};
      const layerHeight = {};

      if (visibleLayers.has('conceptual')) {
        layerY.conceptual = currentY;
        layerHeight.conceptual = calculateLayerHeight('conceptual');
        currentY += layerHeight.conceptual + 50; // å±‚é«˜åº¦ + å±‚é—´è·
      }

      if (visibleLayers.has('subject')) {
        layerY.subject = currentY;
        layerHeight.subject = calculateLayerHeight('subject');
        currentY += layerHeight.subject + 60;
      }

      if (visibleLayers.has('logical')) {
        layerY.logical = currentY;
        layerHeight.logical = calculateLayerHeight('logical');
        currentY += layerHeight.logical + 60;
      }

      if (visibleLayers.has('physical')) {
        layerY.physical = currentY;
        layerHeight.physical = calculateLayerHeight('physical');
        currentY += layerHeight.physical + 50;
      }

      // 1. ç»˜åˆ¶æ¦‚å¿µæ¨¡å‹å±‚
      if (visibleLayers.has('conceptual')) {
        drawConceptualLayer(layerY.conceptual, layerHeight.conceptual);
      }

      // 2. ç»˜åˆ¶ä¸»é¢˜åŸŸå±‚
      if (visibleLayers.has('subject')) {
        drawSubjectLayer(layerY.subject, layerHeight.subject);
      }

      // 3. ç»˜åˆ¶é€»è¾‘æ¨¡å‹å±‚
      if (visibleLayers.has('logical')) {
        drawLogicalLayer(layerY.logical, layerHeight.logical);
      }

      // 4. ç»˜åˆ¶ç‰©ç†æ¨¡å‹å±‚
      if (visibleLayers.has('physical')) {
        drawPhysicalLayer(layerY.physical, layerHeight.physical);
      }

      // 5. ç»˜åˆ¶å‚ç›´å…³ç³»ï¼ˆå±‚æ¬¡é—´çš„åˆ†è§£å…³ç³»ï¼‰
      drawVerticalRelations(layerY, layerHeight);

      // 6. ç»˜åˆ¶æ¨ªå‘å…³ç³»ï¼ˆåŒå±‚æ¨¡å‹é—´çš„å…³è”ï¼‰
      if (visibleLayers.has('subject')) {
        drawHorizontalRelations(layerY.subject, layerHeight.subject);
      }

      // æ›´æ–°viewBoxä»¥é€‚åº”å†…å®¹
      updateSVGViewBox();
    }

    function drawConceptualLayer(y, height) {
      const data = dataModelArchitecture.conceptual;
      const width = 1500;

      // å±‚èƒŒæ™¯
      g.append('rect')
        .attr('class', 'model-layer-group')
        .attr('x', 30)
        .attr('y', y)
        .attr('width', width)
        .attr('height', height);

      // å±‚æ ‡ç­¾
      g.append('text')
        .attr('class', 'model-layer-label')
        .attr('x', 50)
        .attr('y', y + 30)
        .text('æ¦‚å¿µæ¨¡å‹å±‚');

      // åº”ç”¨è‡ªå®šä¹‰å¸ƒå±€
      const customPos = customLayout['conceptual'];
      const defaultX = 565; // é»˜è®¤å±…ä¸­
      const defaultY = 0; // ç›¸å¯¹äºå±‚çš„åç§»
      const nodeX = customPos ? customPos.x : defaultX;
      const nodeY = y + 50 + (customPos ? customPos.y : defaultY);
      const nodeWidth = customPos?.width || 400;
      const nodeHeight = customPos?.height || 70;

      // æ¦‚å¿µæ¨¡å‹èŠ‚ç‚¹ï¼ˆæ”¯æŒæ‹–æ‹½å’Œå°ºå¯¸è°ƒæ•´ï¼‰
      const nodeG = g.append('g')
        .attr('class', 'model-group')
        .attr('data-id', data.id)
        .attr('transform', `translate(0, 0)`)
        .style('cursor', 'grab');

      // èŠ‚ç‚¹çŸ©å½¢
      nodeG.append('rect')
        .attr('class', 'model-node')
        .attr('x', nodeX)
        .attr('y', nodeY)
        .attr('width', nodeWidth)
        .attr('height', nodeHeight)
        .attr('rx', 8)
        .on('mousedown', function(event) {
          startDrag(event, nodeG.node(), 'conceptual', nodeX, nodeY, y);
        });

      // èŠ‚ç‚¹æ–‡å­—ï¼ˆå±…ä¸­ï¼‰
      nodeG.append('text')
        .attr('class', 'model-text')
        .attr('x', nodeX + nodeWidth / 2)
        .attr('y', nodeY + nodeHeight / 2 + 5)
        .text(data.name);

      // è°ƒæ•´å°ºå¯¸æ‰‹æŸ„ï¼ˆå³ä¸‹è§’ï¼‰
      nodeG.append('circle')
        .attr('class', 'resize-handle')
        .attr('cx', nodeX + nodeWidth)
        .attr('cy', nodeY + nodeHeight)
        .attr('r', 5)
        .on('mousedown', function(event) {
          event.stopPropagation();
          startResize(event, nodeG.node(), 'conceptual', nodeX, nodeY, nodeWidth, nodeHeight, y);
        });
    }

    function drawSubjectLayer(y, height) {
      const subjects = dataModelArchitecture.subjects;
      const width = 1500;

      // å±‚èƒŒæ™¯
      g.append('rect')
        .attr('class', 'model-layer-group')
        .attr('x', 30)
        .attr('y', y)
        .attr('width', width)
        .attr('height', height);

      // å±‚æ ‡ç­¾
      g.append('text')
        .attr('class', 'model-layer-label')
        .attr('x', 50)
        .attr('y', y + 30)
        .text('ä¸»é¢˜åŸŸå±‚');

      // ä¸»é¢˜åŸŸèŠ‚ç‚¹ï¼ˆæ”¯æŒæ‹–æ‹½å’Œå°ºå¯¸è°ƒæ•´ï¼‰
      subjects.forEach(subject => {
        // åº”ç”¨è‡ªå®šä¹‰å¸ƒå±€
        const customPos = customLayout[subject.id];
        const nodeX = customPos ? customPos.x : subject.x;
        const nodeY = y + 50 + (customPos ? customPos.y : 0);
        const nodeWidth = customPos?.width || 140;
        const nodeHeight = customPos?.height || 80;

        const nodeG = g.append('g')
          .attr('class', 'model-group')
          .attr('data-id', subject.id)
          .attr('transform', `translate(0, 0)`)
          .style('cursor', 'grab');

        // èŠ‚ç‚¹çŸ©å½¢
        nodeG.append('rect')
          .attr('class', 'model-node')
          .attr('x', nodeX)
          .attr('y', nodeY)
          .attr('width', nodeWidth)
          .attr('height', nodeHeight)
          .attr('rx', 8)
          .on('mousedown', function(event) {
            startDrag(event, nodeG.node(), subject.id, nodeX, nodeY, y);
          });

        // èŠ‚ç‚¹æ–‡å­—ï¼ˆå±…ä¸­ï¼‰
        nodeG.append('text')
          .attr('class', 'model-text')
          .attr('x', nodeX + nodeWidth / 2)
          .attr('y', nodeY + nodeHeight / 2 - 5)
          .text(subject.name);

        nodeG.append('text')
          .attr('class', 'model-count')
          .attr('x', nodeX + nodeWidth / 2)
          .attr('y', nodeY + nodeHeight / 2 + 15)
          .text(`${subject.entityCount}ä¸ªå®ä½“`);

        // è°ƒæ•´å°ºå¯¸æ‰‹æŸ„ï¼ˆå³ä¸‹è§’ï¼‰
        nodeG.append('circle')
          .attr('class', 'resize-handle')
          .attr('cx', nodeX + nodeWidth)
          .attr('cy', nodeY + nodeHeight)
          .attr('r', 5)
          .on('mousedown', function(event) {
            event.stopPropagation();
            startResize(event, nodeG.node(), subject.id, nodeX, nodeY, nodeWidth, nodeHeight, y);
          });
      });
    }

    function drawLogicalLayer(y, height) {
      const logicalModels = dataModelArchitecture.logical;
      const width = 1500;

      // å±‚èƒŒæ™¯
      g.append('rect')
        .attr('class', 'model-layer-group')
        .attr('x', 30)
        .attr('y', y)
        .attr('width', width)
        .attr('height', height);

      // å±‚æ ‡ç­¾
      g.append('text')
        .attr('class', 'model-layer-label')
        .attr('x', 50)
        .attr('y', y + 30)
        .text('é€»è¾‘æ¨¡å‹å±‚');

      // é€»è¾‘æ¨¡å‹èŠ‚ç‚¹ï¼ˆæ”¯æŒæ‹–æ‹½å’Œå°ºå¯¸è°ƒæ•´ï¼‰
      logicalModels.forEach(logical => {
        // åº”ç”¨è‡ªå®šä¹‰å¸ƒå±€
        const customPos = customLayout[logical.id];
        const nodeX = customPos ? customPos.x : logical.x;
        const nodeY = y + 50 + (customPos ? customPos.y : 0);
        const nodeWidth = customPos?.width || 140;
        const nodeHeight = customPos?.height || 80;

        const nodeG = g.append('g')
          .attr('class', 'model-group')
          .attr('data-id', logical.id)
          .attr('transform', `translate(0, 0)`)
          .style('cursor', 'grab');

        // èŠ‚ç‚¹çŸ©å½¢
        nodeG.append('rect')
          .attr('class', 'model-node')
          .attr('x', nodeX)
          .attr('y', nodeY)
          .attr('width', nodeWidth)
          .attr('height', nodeHeight)
          .attr('rx', 8)
          .on('mousedown', function(event) {
            startDrag(event, nodeG.node(), logical.id, nodeX, nodeY, y);
          });

        // èŠ‚ç‚¹æ–‡å­—ï¼ˆå±…ä¸­ï¼‰
        nodeG.append('text')
          .attr('class', 'model-text')
          .attr('x', nodeX + nodeWidth / 2)
          .attr('y', nodeY + nodeHeight / 2 - 5)
          .text(logical.name);

        nodeG.append('text')
          .attr('class', 'model-count')
          .attr('x', nodeX + nodeWidth / 2)
          .attr('y', nodeY + nodeHeight / 2 + 15)
          .text(`${logical.normalization} | ${logical.entityCount}å®ä½“`);

        // è°ƒæ•´å°ºå¯¸æ‰‹æŸ„ï¼ˆå³ä¸‹è§’ï¼‰
        nodeG.append('circle')
          .attr('class', 'resize-handle')
          .attr('cx', nodeX + nodeWidth)
          .attr('cy', nodeY + nodeHeight)
          .attr('r', 5)
          .on('mousedown', function(event) {
            event.stopPropagation();
            startResize(event, nodeG.node(), logical.id, nodeX, nodeY, nodeWidth, nodeHeight, y);
          });
      });
    }

    function drawPhysicalLayer(y, height) {
      const physicalModels = dataModelArchitecture.physical;
      const width = 1500; // æ‰©å¤§ç”»å¸ƒå®½åº¦

      // ä¿å­˜ç‰©ç†å±‚çš„Yåæ ‡ï¼Œç”¨äºæ‹–æ‹½è®¡ç®—
      dragState.layerY = y;

      // å±‚èƒŒæ™¯
      g.append('rect')
        .attr('class', 'model-layer-group')
        .attr('x', 30)
        .attr('y', y)
        .attr('width', width)
        .attr('height', height);

      // å±‚æ ‡ç­¾
      g.append('text')
        .attr('class', 'model-layer-label')
        .attr('x', 50)
        .attr('y', y + 30)
        .text('ç‰©ç†æ¨¡å‹å±‚');

      // ç‰©ç†æ¨¡å‹èŠ‚ç‚¹ï¼ˆæ”¯æŒä¸Šä¸‹ä¸¤è¡Œå¸ƒå±€ + æ‹–æ‹½åŠŸèƒ½ + å°ºå¯¸è°ƒæ•´ï¼‰
      physicalModels.forEach(physical => {
        // åº”ç”¨è‡ªå®šä¹‰å¸ƒå±€ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
        const customPos = customLayout[physical.id];
        const nodeX = customPos ? customPos.x : physical.x;
        const nodeY = y + 50 + (customPos ? customPos.y : (physical.y || 0));
        const nodeWidth = customPos?.width || 90;
        const nodeHeight = customPos?.height || 60;

        const nodeG = g.append('g')
          .attr('class', 'model-group')
          .attr('data-id', physical.id)
          .attr('transform', `translate(0, 0)`)
          .style('cursor', 'grab');

        // èŠ‚ç‚¹çŸ©å½¢
        nodeG.append('rect')
          .attr('class', 'model-node')
          .attr('x', nodeX)
          .attr('y', nodeY)
          .attr('width', nodeWidth)
          .attr('height', nodeHeight)
          .attr('rx', 6)
          .on('mousedown', function(event) {
            // åªæœ‰ç‚¹å‡»èŠ‚ç‚¹ä¸»ä½“æ‰è§¦å‘æ‹–æ‹½
            startDrag(event, nodeG.node(), physical.id, nodeX, nodeY, y);
          });

        // èŠ‚ç‚¹æ–‡å­—ï¼ˆå±…ä¸­ï¼‰
        nodeG.append('text')
          .attr('class', 'model-text')
          .attr('x', nodeX + nodeWidth / 2)
          .attr('y', nodeY + nodeHeight / 2 - 5)
          .style('font-size', '11px')
          .text(physical.name);

        nodeG.append('text')
          .attr('class', 'model-count')
          .attr('x', nodeX + nodeWidth / 2)
          .attr('y', nodeY + nodeHeight / 2 + 10)
          .style('font-size', '10px')
          .text(`${physical.tableCount}è¡¨`);

        // è°ƒæ•´å°ºå¯¸æ‰‹æŸ„ï¼ˆå³ä¸‹è§’ï¼‰
        nodeG.append('circle')
          .attr('class', 'resize-handle')
          .attr('cx', nodeX + nodeWidth)
          .attr('cy', nodeY + nodeHeight)
          .attr('r', 5)
          .on('mousedown', function(event) {
            event.stopPropagation(); // é˜»æ­¢è§¦å‘æ‹–æ‹½
            startResize(event, nodeG.node(), physical.id, nodeX, nodeY, nodeWidth, nodeHeight, y);
          });
      });
    }

    function drawVerticalRelations(layerY, layerHeight) {
      // æ¦‚å¿µæ¨¡å‹ â†’ ä¸»é¢˜åŸŸ
      if (visibleLayers.has('conceptual') && visibleLayers.has('subject')) {
        dataModelArchitecture.subjects.forEach(subject => {
          // åº”ç”¨è‡ªå®šä¹‰å¸ƒå±€
          const conceptualCustom = customLayout['conceptual'];
          const subjectCustom = customLayout[subject.id];

          const conceptualX = conceptualCustom ? conceptualCustom.x : 565;
          const conceptualWidth = conceptualCustom?.width || 400;
          const conceptualHeight = conceptualCustom?.height || 70;

          const subjectX = subjectCustom ? subjectCustom.x : subject.x;
          const subjectWidth = subjectCustom?.width || 140;

          const x1 = conceptualX + conceptualWidth / 2; // æ¦‚å¿µæ¨¡å‹ä¸­å¿ƒ
          const y1 = layerY.conceptual + 50 + (conceptualCustom ? conceptualCustom.y : 0) + conceptualHeight; // æ¦‚å¿µæ¨¡å‹åº•éƒ¨
          const x2 = subjectX + subjectWidth / 2; // ä¸»é¢˜åŸŸä¸­å¿ƒ
          const y2 = layerY.subject + 50 + (subjectCustom ? subjectCustom.y : 0); // ä¸»é¢˜åŸŸé¡¶éƒ¨

          g.append('path')
            .attr('class', 'vertical-relation')
            .attr('data-source', 'conceptual')
            .attr('data-target', subject.id)
            .attr('data-source-x', x1)
            .attr('data-source-y', y1)
            .attr('data-target-x', x2)
            .attr('data-target-y', y2)
            .attr('d', `M ${x1} ${y1} L ${x2} ${y2}`);
        });
      }

      // ä¸»é¢˜åŸŸ â†’ é€»è¾‘æ¨¡å‹
      if (visibleLayers.has('subject') && visibleLayers.has('logical')) {
        dataModelArchitecture.logical.forEach(logical => {
          const subject = dataModelArchitecture.subjects.find(s => s.id === logical.subjectId);
          if (subject) {
            // åº”ç”¨è‡ªå®šä¹‰å¸ƒå±€
            const subjectCustom = customLayout[subject.id];
            const logicalCustom = customLayout[logical.id];

            const subjectX = subjectCustom ? subjectCustom.x : subject.x;
            const subjectY = subjectCustom ? subjectCustom.y : 0;
            const subjectWidth = subjectCustom?.width || 140;
            const subjectHeight = subjectCustom?.height || 80;

            const logicalX = logicalCustom ? logicalCustom.x : logical.x;
            const logicalWidth = logicalCustom?.width || 140;

            const x1 = subjectX + subjectWidth / 2; // ä¸»é¢˜åŸŸä¸­å¿ƒ
            const y1 = layerY.subject + 50 + subjectY + subjectHeight; // ä¸»é¢˜åŸŸåº•éƒ¨
            const x2 = logicalX + logicalWidth / 2; // é€»è¾‘æ¨¡å‹ä¸­å¿ƒ
            const y2 = layerY.logical + 50 + (logicalCustom ? logicalCustom.y : 0); // é€»è¾‘æ¨¡å‹é¡¶éƒ¨

            g.append('path')
              .attr('class', 'vertical-relation')
              .attr('data-source', subject.id)
              .attr('data-target', logical.id)
              .attr('data-source-x', x1)
              .attr('data-source-y', y1)
              .attr('data-target-x', x2)
              .attr('data-target-y', y2)
              .attr('d', `M ${x1} ${y1} L ${x2} ${y2}`);
          }
        });
      }

      // é€»è¾‘æ¨¡å‹ â†’ ç‰©ç†æ¨¡å‹
      if (visibleLayers.has('logical') && visibleLayers.has('physical')) {
        dataModelArchitecture.physical.forEach(physical => {
          const logical = dataModelArchitecture.logical.find(l => l.id === physical.logicalId);
          if (logical) {
            // åº”ç”¨è‡ªå®šä¹‰å¸ƒå±€
            const logicalCustom = customLayout[logical.id];
            const physicalCustom = customLayout[physical.id];

            const logicalX = logicalCustom ? logicalCustom.x : logical.x;
            const logicalY = logicalCustom ? logicalCustom.y : 0;
            const logicalWidth = logicalCustom?.width || 140;
            const logicalHeight = logicalCustom?.height || 80;

            const physicalX = physicalCustom ? physicalCustom.x : physical.x;
            const physicalY = physicalCustom ? physicalCustom.y : (physical.y || 0);
            const physicalWidth = physicalCustom?.width || 90;

            const x1 = logicalX + logicalWidth / 2; // é€»è¾‘æ¨¡å‹ä¸­å¿ƒ
            const y1 = layerY.logical + 50 + logicalY + logicalHeight; // é€»è¾‘æ¨¡å‹åº•éƒ¨
            const x2 = physicalX + physicalWidth / 2; // ç‰©ç†æ¨¡å‹ä¸­å¿ƒ
            const y2 = layerY.physical + 50 + physicalY; // ç‰©ç†æ¨¡å‹é¡¶éƒ¨

            g.append('path')
              .attr('class', 'vertical-relation')
              .attr('data-source', logical.id)
              .attr('data-target', physical.id)
              .attr('data-source-x', x1)
              .attr('data-source-y', y1)
              .attr('data-target-x', x2)
              .attr('data-target-y', y2)
              .attr('d', `M ${x1} ${y1} L ${x2} ${y2}`);
          }
        });
      }
    }

    function drawHorizontalRelations(y, layerHeight) {
      dataModelArchitecture.horizontalRelations.forEach(rel => {
        const fromSubject = dataModelArchitecture.subjects.find(s => s.id === rel.from);
        const toSubject = dataModelArchitecture.subjects.find(s => s.id === rel.to);

        if (fromSubject && toSubject) {
          // åº”ç”¨è‡ªå®šä¹‰å¸ƒå±€
          const fromCustom = customLayout[fromSubject.id];
          const toCustom = customLayout[toSubject.id];

          const fromX = fromCustom ? fromCustom.x : fromSubject.x;
          const fromY = fromCustom ? fromCustom.y : 0;
          const fromWidth = fromCustom?.width || 140;
          const fromHeight = fromCustom?.height || 80;

          const toX = toCustom ? toCustom.x : toSubject.x;
          const toY = toCustom ? toCustom.y : 0;
          const toWidth = toCustom?.width || 140;
          const toHeight = toCustom?.height || 80;

          const x1 = fromX + fromWidth; // èµ·ç‚¹ï¼šæºèŠ‚ç‚¹å³è¾¹ç¼˜
          const y1 = y + 50 + fromY + fromHeight / 2; // èµ·ç‚¹ï¼šèŠ‚ç‚¹ä¸­å¿ƒé«˜åº¦
          const x2 = toX; // ç»ˆç‚¹ï¼šç›®æ ‡èŠ‚ç‚¹å·¦è¾¹ç¼˜
          const y2 = y + 50 + toY + toHeight / 2; // ç»ˆç‚¹ï¼šèŠ‚ç‚¹ä¸­å¿ƒé«˜åº¦

          g.append('path')
            .attr('class', 'horizontal-relation')
            .attr('data-source', fromSubject.id)
            .attr('data-target', toSubject.id)
            .attr('d', `M ${x1} ${y1} L ${x2} ${y2}`);
        }
      });
    }

    function selectModel(model, layerType) {
      selectedModel = { model, layerType };

      // æ›´æ–°è§†è§‰é€‰æ‹©
      g.selectAll('.model-node').classed('selected', false);
      g.selectAll('.model-text').classed('selected', false);
      g.selectAll('.model-count').classed('selected', false);

      g.selectAll(`.model-group[data-id="${model.id}"] .model-node`).classed('selected', true);
      g.selectAll(`.model-group[data-id="${model.id}"] .model-text`).classed('selected', true);
      g.selectAll(`.model-group[data-id="${model.id}"] .model-count`).classed('selected', true);

      // æ›´æ–°è¯¦æƒ…é¢æ¿
      updateModelDetailPanel(model, layerType);
    }

    function updateModelDetailPanel(model, layerType) {
      const detailContent = document.getElementById('model-detail-content');

      let detailHTML = '';

      if (layerType === 'conceptual') {
        detailHTML = `
          <div class="model-detail">
            <h4>ğŸ“Š ${model.name}</h4>
            <div class="detail-section">
              <div class="detail-section-title">æ¨¡å‹æè¿°</div>
              <div class="detail-row">
                <div class="detail-value">${model.description}</div>
              </div>
            </div>
            <div class="detail-section">
              <div class="detail-section-title">æ ¸å¿ƒä¸šåŠ¡æ¦‚å¿µ</div>
              <div class="entity-list">
                ${model.entities.map(e => `<div class="entity-item">${e}</div>`).join('')}
              </div>
            </div>
            <div class="detail-section">
              <div class="detail-section-title">æ¶æ„ç»Ÿè®¡</div>
              <div class="stats-grid">
                <div class="stat-card">
                  <div class="stat-value">15</div>
                  <div class="stat-label">ä¸»é¢˜åŸŸ</div>
                </div>
                <div class="stat-card">
                  <div class="stat-value">750+</div>
                  <div class="stat-label">æ€»å®ä½“</div>
                </div>
              </div>
            </div>
          </div>
        `;
      } else if (layerType === 'subject') {
        detailHTML = `
          <div class="model-detail">
            <h4>ğŸ“¦ ${model.name}</h4>
            <div class="detail-section">
              <div class="detail-section-title">åŸºæœ¬ä¿¡æ¯</div>
              <div class="detail-row">
                <div class="detail-label">ä¸»é¢˜åŸŸID</div>
                <div class="detail-value">${model.id}</div>
              </div>
              <div class="detail-row">
                <div class="detail-label">å®ä½“æ•°é‡</div>
                <div class="detail-value">${model.entityCount}ä¸ª</div>
              </div>
              <div class="detail-row">
                <div class="detail-label">æè¿°</div>
                <div class="detail-value">${model.description}</div>
              </div>
            </div>
            <div class="detail-section">
              <div class="detail-section-title">å…³è”å…³ç³»</div>
              <div class="detail-row">
                <div class="detail-label">ä¸Šæ¸¸æ¨¡å‹</div>
                <div class="detail-value">ä¼ä¸šæ•°æ®æ¨¡å‹</div>
              </div>
              <div class="detail-row">
                <div class="detail-label">ä¸‹æ¸¸æ¨¡å‹</div>
                <div class="detail-value">${model.name.replace('ä¸»é¢˜åŸŸ', 'é€»è¾‘æ¨¡å‹')}</div>
              </div>
            </div>
            <div class="detail-section">
              <div class="detail-section-title">æ•°æ®æ²»ç†</div>
              <div class="detail-row">
                <div class="detail-label">æ•°æ®è´Ÿè´£äºº</div>
                <div class="detail-value">å¼ ä¸‰</div>
              </div>
              <div class="detail-row">
                <div class="detail-label">æœ¯è¯­è¦†ç›–ç‡</div>
                <div class="detail-value">92%</div>
              </div>
            </div>
          </div>
        `;
      } else if (layerType === 'logical') {
        detailHTML = `
          <div class="model-detail">
            <h4>ğŸ”· ${model.name}</h4>
            <div class="detail-section">
              <div class="detail-section-title">åŸºæœ¬ä¿¡æ¯</div>
              <div class="detail-row">
                <div class="detail-label">æ¨¡å‹ID</div>
                <div class="detail-value">${model.id}</div>
              </div>
              <div class="detail-row">
                <div class="detail-label">è§„èŒƒåŒ–çº§åˆ«</div>
                <div class="detail-value">${model.normalization}</div>
              </div>
              <div class="detail-row">
                <div class="detail-label">å®ä½“æ•°é‡</div>
                <div class="detail-value">${model.entityCount}ä¸ª</div>
              </div>
            </div>
            <div class="detail-section">
              <div class="detail-section-title">æ¨¡å‹å…³ç³»</div>
              <div class="detail-row">
                <div class="detail-label">æ‰€å±ä¸»é¢˜åŸŸ</div>
                <div class="detail-value">${model.subjectId}</div>
              </div>
              <div class="detail-row">
                <div class="detail-label">ç‰©ç†å®ç°</div>
                <div class="detail-value">3ä¸ªæ•°æ®åº“</div>
              </div>
            </div>
            <div class="detail-section">
              <div class="detail-section-title">è´¨é‡æŒ‡æ ‡</div>
              <div class="stats-grid">
                <div class="stat-card">
                  <div class="stat-value">98%</div>
                  <div class="stat-label">å®Œæ•´æ€§</div>
                </div>
                <div class="stat-card">
                  <div class="stat-value">95%</div>
                  <div class="stat-label">ä¸€è‡´æ€§</div>
                </div>
              </div>
            </div>
          </div>
        `;
      } else if (layerType === 'physical') {
        detailHTML = `
          <div class="model-detail">
            <h4>ğŸ’¾ ${model.name}</h4>
            <div class="detail-section">
              <div class="detail-section-title">åŸºæœ¬ä¿¡æ¯</div>
              <div class="detail-row">
                <div class="detail-label">ç‰©ç†æ¨¡å‹ID</div>
                <div class="detail-value">${model.id}</div>
              </div>
              <div class="detail-row">
                <div class="detail-label">æ•°æ®åº“å¹³å°</div>
                <div class="detail-value">${model.platform}</div>
              </div>
              <div class="detail-row">
                <div class="detail-label">è¡¨æ•°é‡</div>
                <div class="detail-value">${model.tableCount}å¼ </div>
              </div>
            </div>
            <div class="detail-section">
              <div class="detail-section-title">æ¨¡å‹å…³ç³»</div>
              <div class="detail-row">
                <div class="detail-label">é€»è¾‘æ¨¡å‹</div>
                <div class="detail-value">${model.logicalId}</div>
              </div>
              <div class="detail-row">
                <div class="detail-label">åº”ç”¨ç³»ç»Ÿ</div>
                <div class="detail-value">${model.name}</div>
              </div>
            </div>
            <div class="detail-section">
              <div class="detail-section-title">è¿ç»´ä¿¡æ¯</div>
              <div class="detail-row">
                <div class="detail-label">æ•°æ®é‡</div>
                <div class="detail-value">1.2TB</div>
              </div>
              <div class="detail-row">
                <div class="detail-label">æ›´æ–°é¢‘ç‡</div>
                <div class="detail-value">å®æ—¶</div>
              </div>
            </div>
          </div>
        `;
      }

      detailContent.innerHTML = detailHTML;
    }

    function toggleLayer(element, layerId) {
      element.classList.toggle('active');

      if (visibleLayers.has(layerId)) {
        visibleLayers.delete(layerId);
        element.querySelector('.layer-toggle').textContent = '';
      } else {
        visibleLayers.add(layerId);
        element.querySelector('.layer-toggle').textContent = 'âœ“';
      }

      renderArchitecture();
      updateSVGViewBox(); // åˆ‡æ¢å±‚æ—¶æ›´æ–°viewBox
    }

    function zoomIn() {
      svg.transition().call(zoom.scaleBy, 1.3);
    }

    function zoomOut() {
      svg.transition().call(zoom.scaleBy, 0.7);
    }

    function resetZoom() {
      svg.transition().call(zoom.transform, d3.zoomIdentity);
    }

    function exportDiagram() {
      alert('å¯¼å‡ºPNGåŠŸèƒ½å¼€å‘ä¸­...');
    }

    function optimizeArchitecture() {
      alert('AIä¼˜åŒ–å»ºè®®åŠŸèƒ½å¼€å‘ä¸­...');
    }

    // ========== æ‹–æ‹½åŠŸèƒ½ ==========

    function startDrag(event, node, nodeId, currentX, currentY, layerY) {
      event.stopPropagation();

      dragState.isDragging = true;
      dragState.currentNode = node;
      dragState.currentNodeId = nodeId;
      dragState.startX = event.clientX;
      dragState.startY = event.clientY;
      dragState.offsetX = 0;
      dragState.offsetY = 0;
      dragState.layerY = layerY; // ä¿å­˜å±‚çš„Yåæ ‡

      // æ·»åŠ æ‹–æ‹½æ ·å¼
      d3.select(node).classed('dragging', true);
      d3.select(node).select('.model-node').classed('dragging', true);

      // æ·»åŠ å…¨å±€äº‹ä»¶ç›‘å¬
      d3.select('body')
        .on('mousemove.drag', onDrag)
        .on('mouseup.drag', endDrag);
    }

    function onDrag(event) {
      if (!dragState.isDragging) return;

      // è®¡ç®—åç§»é‡
      dragState.offsetX = event.clientX - dragState.startX;
      dragState.offsetY = event.clientY - dragState.startY;

      // æ›´æ–°èŠ‚ç‚¹ä½ç½®ï¼ˆä½¿ç”¨transformï¼‰
      d3.select(dragState.currentNode)
        .attr('transform', `translate(${dragState.offsetX}, ${dragState.offsetY})`);

      // å®æ—¶æ›´æ–°æ‰€æœ‰ç›¸å…³è¿æ¥çº¿
      updateAllConnectionLines(dragState.currentNodeId);
    }

    function endDrag(event) {
      if (!dragState.isDragging) return;

      // æ£€æŸ¥æ˜¯å¦æ˜¯ç‚¹å‡»ï¼ˆæ‹–æ‹½è·ç¦»å¾ˆå°ï¼‰
      const distance = Math.sqrt(dragState.offsetX ** 2 + dragState.offsetY ** 2);
      const isClick = distance < 5;

      // æŸ¥æ‰¾èŠ‚ç‚¹æ•°æ®ï¼ˆæ”¯æŒæ‰€æœ‰å±‚ï¼‰
      let nodeData = null;
      let nodeType = null;
      let defaultX = 0;
      let defaultY = 0;

      if (dragState.currentNodeId === 'conceptual') {
        nodeData = dataModelArchitecture.conceptual;
        nodeType = 'conceptual';
        defaultX = 565;
        defaultY = 0;
      } else {
        // æŸ¥æ‰¾ä¸»é¢˜åŸŸ
        nodeData = dataModelArchitecture.subjects.find(s => s.id === dragState.currentNodeId);
        if (nodeData) {
          nodeType = 'subject';
          defaultX = nodeData.x;
          defaultY = 0;
        } else {
          // æŸ¥æ‰¾é€»è¾‘æ¨¡å‹
          nodeData = dataModelArchitecture.logical.find(l => l.id === dragState.currentNodeId);
          if (nodeData) {
            nodeType = 'logical';
            defaultX = nodeData.x;
            defaultY = 0;
          } else {
            // æŸ¥æ‰¾ç‰©ç†æ¨¡å‹
            nodeData = dataModelArchitecture.physical.find(p => p.id === dragState.currentNodeId);
            if (nodeData) {
              nodeType = 'physical';
              defaultX = nodeData.x;
              defaultY = nodeData.y || 0;
            }
          }
        }
      }

      if (nodeData && !isClick) {
        // åªæœ‰åœ¨çœŸæ­£æ‹–æ‹½æ—¶æ‰ä¿å­˜ä½ç½®
        const customPos = customLayout[dragState.currentNodeId] || { x: defaultX, y: defaultY };
        const newX = customPos.x + dragState.offsetX;
        const newY = customPos.y + dragState.offsetY;

        // ä¿å­˜æ–°ä½ç½®åˆ°è‡ªå®šä¹‰å¸ƒå±€ï¼ˆä¿ç•™åŸæœ‰çš„widthå’Œheightï¼‰
        customLayout[dragState.currentNodeId] = {
          ...customLayout[dragState.currentNodeId],
          x: newX,
          y: newY
        };

        // ä¿å­˜åˆ°localStorage
        saveLayout();
      }

      // ç§»é™¤æ‹–æ‹½æ ·å¼
      d3.select(dragState.currentNode).classed('dragging', false);
      d3.select(dragState.currentNode).select('.model-node').classed('dragging', false);

      // å¦‚æœæ˜¯ç‚¹å‡»ï¼Œè§¦å‘é€‰æ‹©äº‹ä»¶
      if (isClick && nodeData) {
        selectModel(nodeData, nodeType);
      } else if (!isClick) {
        // åªæœ‰åœ¨çœŸæ­£æ‹–æ‹½æ—¶æ‰é‡æ–°æ¸²æŸ“
        renderArchitecture();
      }

      // æ¸…é™¤æ‹–æ‹½çŠ¶æ€
      dragState.isDragging = false;
      dragState.currentNode = null;
      dragState.currentNodeId = null;

      // ç§»é™¤å…¨å±€äº‹ä»¶ç›‘å¬
      d3.select('body')
        .on('mousemove.drag', null)
        .on('mouseup.drag', null);
    }

    // é€šç”¨çš„è¿æ¥çº¿æ›´æ–°å‡½æ•°ï¼ˆæ”¯æŒæ‰€æœ‰å±‚ï¼‰
    function updateAllConnectionLines(nodeId) {
      if (!nodeId) return;

      // è·å–èŠ‚ç‚¹ä¿¡æ¯å’Œä½ç½®
      let nodeData = null;
      let defaultX = 0;
      let defaultY = 0;
      let defaultWidth = 0;
      let layerY = 0;

      // åˆ¤æ–­èŠ‚ç‚¹ç±»å‹å¹¶è·å–é»˜è®¤å€¼
      if (nodeId === 'conceptual') {
        nodeData = dataModelArchitecture.conceptual;
        defaultX = 565;
        defaultY = 0;
        defaultWidth = 400;
        layerY = dragState.layerY;
      } else {
        const subject = dataModelArchitecture.subjects.find(s => s.id === nodeId);
        if (subject) {
          nodeData = subject;
          defaultX = subject.x;
          defaultY = 0;
          defaultWidth = 140;
          layerY = dragState.layerY;
        } else {
          const logical = dataModelArchitecture.logical.find(l => l.id === nodeId);
          if (logical) {
            nodeData = logical;
            defaultX = logical.x;
            defaultY = 0;
            defaultWidth = 140;
            layerY = dragState.layerY;
          } else {
            const physical = dataModelArchitecture.physical.find(p => p.id === nodeId);
            if (physical) {
              nodeData = physical;
              defaultX = physical.x;
              defaultY = physical.y || 0;
              defaultWidth = 90;
              layerY = dragState.layerY;
            }
          }
        }
      }

      if (!nodeData) return;

      // è®¡ç®—å½“å‰èŠ‚ç‚¹çš„å®é™…ä½ç½®
      const customPos = customLayout[nodeId] || { x: defaultX, y: defaultY };
      const nodeWidth = customPos.width || defaultWidth;
      const currentX = customPos.x + dragState.offsetX + nodeWidth / 2; // èŠ‚ç‚¹ä¸­å¿ƒX
      const currentY = layerY + 50 + customPos.y + dragState.offsetY; // èŠ‚ç‚¹é¡¶éƒ¨Yï¼ˆä½œä¸ºtargetï¼‰
      const currentBottomY = layerY + 50 + customPos.y + dragState.offsetY + (customPos.height || 60); // èŠ‚ç‚¹åº•éƒ¨Yï¼ˆä½œä¸ºsourceï¼‰

      // æ›´æ–°ä»¥å½“å‰èŠ‚ç‚¹ä¸ºç›®æ ‡çš„å‚ç›´è¿æ¥çº¿
      g.selectAll(`.vertical-relation[data-target="${nodeId}"]`)
        .attr('d', function() {
          const path = d3.select(this);
          const x1 = parseFloat(path.attr('data-source-x'));
          const y1 = parseFloat(path.attr('data-source-y'));
          return `M ${x1} ${y1} L ${currentX} ${currentY}`;
        });

      // æ›´æ–°ä»¥å½“å‰èŠ‚ç‚¹ä¸ºæºçš„å‚ç›´è¿æ¥çº¿
      g.selectAll(`.vertical-relation[data-source="${nodeId}"]`)
        .attr('d', function() {
          const path = d3.select(this);
          const x2 = parseFloat(path.attr('data-target-x'));
          const y2 = parseFloat(path.attr('data-target-y'));
          return `M ${currentX} ${currentBottomY} L ${x2} ${y2}`;
        });

      // æ›´æ–°æ°´å¹³è¿æ¥çº¿ï¼ˆä¸»é¢˜åŸŸä¹‹é—´ï¼‰
      g.selectAll(`.horizontal-relation[data-source="${nodeId}"]`)
        .attr('d', function() {
          const path = d3.select(this);
          const targetId = path.attr('data-target');
          const targetSubject = dataModelArchitecture.subjects.find(s => s.id === targetId);
          if (!targetSubject) return path.attr('d');

          const targetCustomPos = customLayout[targetId];
          const targetX = targetCustomPos ? targetCustomPos.x : targetSubject.x;
          const targetWidth = targetCustomPos?.width || 140;
          const targetY = layerY + 50 + (targetCustomPos ? targetCustomPos.y : 0);
          const targetHeight = targetCustomPos?.height || 80;

          const x1 = currentX + nodeWidth / 2; // å½“å‰èŠ‚ç‚¹å³è¾¹ç¼˜
          const y1 = currentY + (customPos.height || 80) / 2; // å½“å‰èŠ‚ç‚¹ä¸­å¿ƒY
          const x2 = targetX; // ç›®æ ‡èŠ‚ç‚¹å·¦è¾¹ç¼˜
          const y2 = targetY + targetHeight / 2; // ç›®æ ‡èŠ‚ç‚¹ä¸­å¿ƒY

          return `M ${x1} ${y1} L ${x2} ${y2}`;
        });

      g.selectAll(`.horizontal-relation[data-target="${nodeId}"]`)
        .attr('d', function() {
          const path = d3.select(this);
          const sourceId = path.attr('data-source');
          const sourceSubject = dataModelArchitecture.subjects.find(s => s.id === sourceId);
          if (!sourceSubject) return path.attr('d');

          const sourceCustomPos = customLayout[sourceId];
          const sourceX = sourceCustomPos ? sourceCustomPos.x : sourceSubject.x;
          const sourceWidth = sourceCustomPos?.width || 140;
          const sourceY = layerY + 50 + (sourceCustomPos ? sourceCustomPos.y : 0);
          const sourceHeight = sourceCustomPos?.height || 80;

          const x1 = sourceX + sourceWidth; // æºèŠ‚ç‚¹å³è¾¹ç¼˜
          const y1 = sourceY + sourceHeight / 2; // æºèŠ‚ç‚¹ä¸­å¿ƒY
          const x2 = currentX - nodeWidth / 2; // å½“å‰èŠ‚ç‚¹å·¦è¾¹ç¼˜
          const y2 = currentY + (customPos.height || 80) / 2; // å½“å‰èŠ‚ç‚¹ä¸­å¿ƒY

          return `M ${x1} ${y1} L ${x2} ${y2}`;
        });
    }

    // ========== è°ƒæ•´å°ºå¯¸åŠŸèƒ½ ==========

    function startResize(event, node, nodeId, currentX, currentY, currentWidth, currentHeight, layerY) {
      event.stopPropagation();

      resizeState.isResizing = true;
      resizeState.currentNode = node;
      resizeState.currentNodeId = nodeId;
      resizeState.startX = event.clientX;
      resizeState.startY = event.clientY;
      resizeState.startWidth = currentWidth;
      resizeState.startHeight = currentHeight;
      resizeState.layerY = layerY; // ä¿å­˜å±‚çš„Yåæ ‡

      // æ·»åŠ è°ƒæ•´æ ·å¼
      d3.select(node).select('.resize-handle').classed('resizing', true);

      // æ·»åŠ å…¨å±€äº‹ä»¶ç›‘å¬
      d3.select('body')
        .on('mousemove.resize', onResize)
        .on('mouseup.resize', endResize);
    }

    function onResize(event) {
      if (!resizeState.isResizing) return;

      // è®¡ç®—æ–°å°ºå¯¸
      const deltaX = event.clientX - resizeState.startX;
      const deltaY = event.clientY - resizeState.startY;

      let newWidth = Math.max(resizeState.minWidth, resizeState.startWidth + deltaX);
      let newHeight = Math.max(resizeState.minHeight, resizeState.startHeight + deltaY);

      // è·å–èŠ‚ç‚¹ä¿¡æ¯ï¼ˆæ”¯æŒæ‰€æœ‰å±‚ï¼‰
      let defaultX = 0;
      let defaultY = 0;

      if (resizeState.currentNodeId === 'conceptual') {
        defaultX = 565;
        defaultY = 0;
      } else {
        const subject = dataModelArchitecture.subjects.find(s => s.id === resizeState.currentNodeId);
        if (subject) {
          defaultX = subject.x;
          defaultY = 0;
        } else {
          const logical = dataModelArchitecture.logical.find(l => l.id === resizeState.currentNodeId);
          if (logical) {
            defaultX = logical.x;
            defaultY = 0;
          } else {
            const physical = dataModelArchitecture.physical.find(p => p.id === resizeState.currentNodeId);
            if (physical) {
              defaultX = physical.x;
              defaultY = physical.y || 0;
            }
          }
        }
      }

      // æ›´æ–°èŠ‚ç‚¹å°ºå¯¸ï¼ˆç›´æ¥ä¿®æ”¹DOMï¼Œæ€§èƒ½æ›´å¥½ï¼‰
      const nodeG = d3.select(resizeState.currentNode);
      const customPos = customLayout[resizeState.currentNodeId] || { x: defaultX, y: defaultY };
      const nodeX = customPos.x;
      const nodeY = resizeState.layerY + 50 + customPos.y;

      // æ›´æ–°çŸ©å½¢å°ºå¯¸
      nodeG.select('.model-node')
        .attr('width', newWidth)
        .attr('height', newHeight);

      // æ›´æ–°æ–‡å­—ä½ç½®ï¼ˆå±…ä¸­ï¼‰
      nodeG.select('.model-text')
        .attr('x', nodeX + newWidth / 2)
        .attr('y', nodeY + newHeight / 2 - 5);

      nodeG.select('.model-count')
        .attr('x', nodeX + newWidth / 2)
        .attr('y', nodeY + newHeight / 2 + 10);

      // æ›´æ–°è°ƒæ•´æ‰‹æŸ„ä½ç½®
      nodeG.select('.resize-handle')
        .attr('cx', nodeX + newWidth)
        .attr('cy', nodeY + newHeight);

      // æ›´æ–°è¿æ¥çº¿ï¼ˆå› ä¸ºèŠ‚ç‚¹ä¸­å¿ƒä½ç½®å˜äº†ï¼‰
      updateConnectionLinesForResize(resizeState.currentNodeId, nodeX, nodeY, newWidth, newHeight);
    }

    function endResize(event) {
      if (!resizeState.isResizing) return;

      // è®¡ç®—æœ€ç»ˆå°ºå¯¸
      const deltaX = event.clientX - resizeState.startX;
      const deltaY = event.clientY - resizeState.startY;

      const newWidth = Math.max(resizeState.minWidth, resizeState.startWidth + deltaX);
      const newHeight = Math.max(resizeState.minHeight, resizeState.startHeight + deltaY);

      // è·å–èŠ‚ç‚¹é»˜è®¤ä½ç½®ï¼ˆæ”¯æŒæ‰€æœ‰å±‚ï¼‰
      let defaultX = 0;
      let defaultY = 0;

      if (resizeState.currentNodeId === 'conceptual') {
        defaultX = 565;
        defaultY = 0;
      } else {
        const subject = dataModelArchitecture.subjects.find(s => s.id === resizeState.currentNodeId);
        if (subject) {
          defaultX = subject.x;
          defaultY = 0;
        } else {
          const logical = dataModelArchitecture.logical.find(l => l.id === resizeState.currentNodeId);
          if (logical) {
            defaultX = logical.x;
            defaultY = 0;
          } else {
            const physical = dataModelArchitecture.physical.find(p => p.id === resizeState.currentNodeId);
            if (physical) {
              defaultX = physical.x;
              defaultY = physical.y || 0;
            }
          }
        }
      }

      // ä¿å­˜æ–°å°ºå¯¸åˆ°è‡ªå®šä¹‰å¸ƒå±€
      const customPos = customLayout[resizeState.currentNodeId] || { x: defaultX, y: defaultY };

      customLayout[resizeState.currentNodeId] = {
        ...customPos,
        width: newWidth,
        height: newHeight
      };

      // ä¿å­˜åˆ°localStorage
      saveLayout();

      // ç§»é™¤è°ƒæ•´æ ·å¼
      d3.select(resizeState.currentNode).select('.resize-handle').classed('resizing', false);

      // é‡æ–°æ¸²æŸ“ï¼ˆåº”ç”¨æ–°å°ºå¯¸ï¼‰
      renderArchitecture();

      // æ¸…é™¤è°ƒæ•´çŠ¶æ€
      resizeState.isResizing = false;
      resizeState.currentNode = null;
      resizeState.currentNodeId = null;

      // ç§»é™¤å…¨å±€äº‹ä»¶ç›‘å¬
      d3.select('body')
        .on('mousemove.resize', null)
        .on('mouseup.resize', null);
    }

    function updateConnectionLinesForResize(nodeId, nodeX, nodeY, nodeWidth, nodeHeight) {
      // æ›´æ–°è¿æ¥çº¿ï¼ˆèŠ‚ç‚¹ä¸­å¿ƒä½ç½®å’Œåº•éƒ¨ä½ç½®éƒ½å¯èƒ½å˜åŒ–ï¼‰
      const currentX = nodeX + nodeWidth / 2; // èŠ‚ç‚¹ä¸­å¿ƒX
      const currentY = nodeY; // èŠ‚ç‚¹é¡¶éƒ¨Yï¼ˆä½œä¸ºtargetï¼‰
      const currentBottomY = nodeY + nodeHeight; // èŠ‚ç‚¹åº•éƒ¨Yï¼ˆä½œä¸ºsourceï¼‰

      // æ›´æ–°ä»¥å½“å‰èŠ‚ç‚¹ä¸ºç›®æ ‡çš„å‚ç›´è¿æ¥çº¿
      g.selectAll(`.vertical-relation[data-target="${nodeId}"]`)
        .attr('d', function() {
          const path = d3.select(this);
          const x1 = parseFloat(path.attr('data-source-x'));
          const y1 = parseFloat(path.attr('data-source-y'));
          return `M ${x1} ${y1} L ${currentX} ${currentY}`;
        });

      // æ›´æ–°ä»¥å½“å‰èŠ‚ç‚¹ä¸ºæºçš„å‚ç›´è¿æ¥çº¿
      g.selectAll(`.vertical-relation[data-source="${nodeId}"]`)
        .attr('d', function() {
          const path = d3.select(this);
          const x2 = parseFloat(path.attr('data-target-x'));
          const y2 = parseFloat(path.attr('data-target-y'));
          return `M ${currentX} ${currentBottomY} L ${x2} ${y2}`;
        });

      // æ›´æ–°æ°´å¹³è¿æ¥çº¿
      const centerY = nodeY + nodeHeight / 2;

      g.selectAll(`.horizontal-relation[data-source="${nodeId}"]`)
        .attr('d', function() {
          const path = d3.select(this);
          const targetId = path.attr('data-target');
          const targetSubject = dataModelArchitecture.subjects.find(s => s.id === targetId);
          if (!targetSubject) return path.attr('d');

          const targetCustomPos = customLayout[targetId];
          const targetX = targetCustomPos ? targetCustomPos.x : targetSubject.x;
          const targetWidth = targetCustomPos?.width || 140;
          const targetY = resizeState.layerY + 50 + (targetCustomPos ? targetCustomPos.y : 0);
          const targetHeight = targetCustomPos?.height || 80;

          const x1 = currentX + nodeWidth / 2;
          const y1 = centerY;
          const x2 = targetX;
          const y2 = targetY + targetHeight / 2;

          return `M ${x1} ${y1} L ${x2} ${y2}`;
        });

      g.selectAll(`.horizontal-relation[data-target="${nodeId}"]`)
        .attr('d', function() {
          const path = d3.select(this);
          const sourceId = path.attr('data-source');
          const sourceSubject = dataModelArchitecture.subjects.find(s => s.id === sourceId);
          if (!sourceSubject) return path.attr('d');

          const sourceCustomPos = customLayout[sourceId];
          const sourceX = sourceCustomPos ? sourceCustomPos.x : sourceSubject.x;
          const sourceWidth = sourceCustomPos?.width || 140;
          const sourceY = resizeState.layerY + 50 + (sourceCustomPos ? sourceCustomPos.y : 0);
          const sourceHeight = sourceCustomPos?.height || 80;

          const x1 = sourceX + sourceWidth;
          const y1 = sourceY + sourceHeight / 2;
          const x2 = currentX - nodeWidth / 2;
          const y2 = centerY;

          return `M ${x1} ${y1} L ${x2} ${y2}`;
        });
    }

    function saveLayout() {
      try {
        localStorage.setItem('dama-architecture-layout', JSON.stringify(customLayout));
        console.log('å¸ƒå±€å·²ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨');
      } catch (e) {
        console.error('ä¿å­˜å¸ƒå±€å¤±è´¥:', e);
      }
    }

    function loadLayout() {
      try {
        const saved = localStorage.getItem('dama-architecture-layout');
        if (saved) {
          customLayout = JSON.parse(saved);
          console.log('å·²åŠ è½½è‡ªå®šä¹‰å¸ƒå±€');
        }
      } catch (e) {
        console.error('åŠ è½½å¸ƒå±€å¤±è´¥:', e);
        customLayout = {};
      }
    }

    function resetLayout() {
      if (confirm('ç¡®å®šè¦é‡ç½®ä¸ºé»˜è®¤å¸ƒå±€å—ï¼Ÿè¿™å°†æ¸…é™¤æ‰€æœ‰è‡ªå®šä¹‰ä½ç½®å’Œå°ºå¯¸ã€‚')) {
        customLayout = {};
        localStorage.removeItem('dama-architecture-layout');
        renderArchitecture();
        console.log('å¸ƒå±€å·²é‡ç½®ï¼ˆä½ç½®å’Œå°ºå¯¸æ¢å¤é»˜è®¤ï¼‰');
      }
    }

    // Initialize
    window.addEventListener('DOMContentLoaded', function() {
      loadLayout(); // åŠ è½½ä¿å­˜çš„å¸ƒå±€
      initArchitecture();
      console.log('ä¼ä¸šæ•°æ®æ¨¡å‹æ¶æ„å·²åŠ è½½ - DMBOK2æ ‡å‡†');
    });
  </script>
</body>
</html>