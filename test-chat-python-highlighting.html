<!DOCTYPE html>
<html lang="en" data-theme="light">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Chat Python Highlighting Test</title>
  <link rel="stylesheet" href="/src/styles/main.css">
  <link rel="stylesheet" href="/src/styles/chat.css">
  <link rel="stylesheet" href="/src/styles/syntax-highlighter.css">
  <style>
    body {
      padding: 0;
      margin: 0;
      font-family: var(--font-body);
      background: var(--bg-primary);
    }

    .test-container {
      max-width: 900px;
      margin: 40px auto;
      padding: 20px;
    }

    h1 {
      font-family: var(--font-heading);
      color: var(--text-primary);
      margin-bottom: 24px;
    }

    .theme-toggle {
      margin-bottom: 20px;
      padding: 8px 16px;
      background: var(--active-bg);
      color: var(--active-text);
      border: none;
      border-radius: var(--radius-sm);
      cursor: pointer;
      font-family: var(--font-heading);
    }

    .messages-container {
      display: flex;
      flex-direction: column;
      gap: var(--spacing-lg);
    }

    .verification-banner {
      padding: 16px;
      border-radius: var(--radius-md);
      background: var(--bg-secondary);
      margin-bottom: 20px;
      border-left: 4px solid var(--active-bg);
    }

    .verification-banner h2 {
      font-family: var(--font-heading);
      font-size: var(--font-size-lg);
      margin: 0 0 12px 0;
    }

    .verification-item {
      margin: 4px 0;
      font-size: var(--font-size-sm);
    }

    .verification-item.pass {
      color: #42A592;
    }

    .verification-item.fail {
      color: #E74C3C;
    }
  </style>
</head>
<body>
  <div class="test-container">
    <h1>Chat Python Highlighting Test</h1>
    <p style="color: var(--text-secondary); margin-bottom: 24px;">
      Testing MessageRenderer with Python code in a chat-like interface.
    </p>

    <button class="theme-toggle" onclick="toggleTheme()">Toggle Dark Mode</button>

    <div class="verification-banner" id="verification">
      <h2>Verification: <span id="status">Testing...</span></h2>
      <div id="results"></div>
    </div>

    <div class="messages-container" id="messages"></div>
  </div>

  <script type="module">
    import { getMessageRenderer } from '/src/core/renderer/messageRenderer.ts';

    const markdownWithPython = `请用Python写一个计算阶乘的函数，并给出使用示例

以下是三种不同的Python实现方法：

## 1. 使用 for 循环

\`\`\`python
def factorial_loop(n):
    """
    使用 for 循环计算一个非负整数的阶乘。
    """
    if n == 0:
        return 1

    result = 1
    for i in range(1, n + 1):
        result *= i
    return result
\`\`\`

## 2. 使用递归

\`\`\`python
def factorial_recursive(n):
    """
    使用递归计算阶乘。
    """
    if n == 0 or n == 1:
        return 1
    return n * factorial_recursive(n - 1)
\`\`\`

## 3. 使用示例

\`\`\`python
# 测试三种方法
test_number = 5

result1 = factorial_loop(test_number)
result2 = factorial_recursive(test_number)

print(f"{test_number}! = {result1}")
print(f"{test_number}! = {result2}")
\`\`\`

**输出结果：**
\`\`\`
5! = 120
5! = 120
\`\`\``;

    window.toggleTheme = function() {
      const html = document.documentElement;
      const currentTheme = html.getAttribute('data-theme') || 'light';
      const newTheme = currentTheme === 'light' ? 'dark' : 'light';
      html.setAttribute('data-theme', newTheme);
    };

    async function runTest() {
      const messagesContainer = document.getElementById('messages');
      const renderer = getMessageRenderer();

      // Create assistant message with Python code
      const message = {
        id: `test-${Date.now()}`,
        content: markdownWithPython,
        sender: 'assistant',
        sender_id: 'test-assistant',
        sender_name: 'AI Assistant',
        timestamp: new Date().toISOString(),
        is_streaming: false
      };

      // Render the message
      const result = await renderer.renderMessage(message);

      if (result && result.refs && result.refs.messageContainer) {
        messagesContainer.appendChild(result.refs.messageContainer);

        // Verify syntax highlighting
        setTimeout(() => {
          const contentZone = result.refs.contentZone;
          const codeBlocks = contentZone.querySelectorAll('pre code');

          let pythonBlocks = 0;
          let highlightedBlocks = 0;
          let hasKeywords = false;
          let hasFunctions = false;
          let hasStrings = false;
          let hasComments = false;

          codeBlocks.forEach(block => {
            const lang = block.getAttribute('data-language');
            if (lang === 'python') {
              pythonBlocks++;
              if (block.innerHTML.includes('hljs-')) {
                highlightedBlocks++;
              }
            }

            if (block.innerHTML.includes('hljs-keyword')) hasKeywords = true;
            if (block.innerHTML.includes('hljs-built_in') || block.innerHTML.includes('hljs-title function_')) hasFunctions = true;
            if (block.innerHTML.includes('hljs-string')) hasStrings = true;
            if (block.innerHTML.includes('hljs-comment')) hasComments = true;
          });

          const allPassed = pythonBlocks === 3 &&
                           highlightedBlocks === 3 &&
                           hasKeywords &&
                           hasFunctions &&
                           hasStrings &&
                           hasComments;

          // Update verification banner
          const statusEl = document.getElementById('status');
          const resultsEl = document.getElementById('results');

          statusEl.textContent = allPassed ? '✓ PASS' : '✗ FAIL';
          statusEl.style.color = allPassed ? '#42A592' : '#E74C3C';

          resultsEl.innerHTML = `
            <div class="verification-item ${pythonBlocks === 3 ? 'pass' : 'fail'}">
              ${pythonBlocks === 3 ? '✓' : '✗'} Python code blocks found: ${pythonBlocks}/3
            </div>
            <div class="verification-item ${highlightedBlocks === 3 ? 'pass' : 'fail'}">
              ${highlightedBlocks === 3 ? '✓' : '✗'} Highlighted Python blocks: ${highlightedBlocks}/3
            </div>
            <div class="verification-item ${hasKeywords ? 'pass' : 'fail'}">
              ${hasKeywords ? '✓' : '✗'} Keywords highlighted (def, if, for, return)
            </div>
            <div class="verification-item ${hasFunctions ? 'pass' : 'fail'}">
              ${hasFunctions ? '✓' : '✗'} Functions highlighted (print, range)
            </div>
            <div class="verification-item ${hasStrings ? 'pass' : 'fail'}">
              ${hasStrings ? '✓' : '✗'} Strings highlighted
            </div>
            <div class="verification-item ${hasComments ? 'pass' : 'fail'}">
              ${hasComments ? '✓' : '✗'} Comments highlighted (docstrings, # comments)
            </div>
          `;

          console.log('Verification complete:', {
            pythonBlocks,
            highlightedBlocks,
            hasKeywords,
            hasFunctions,
            hasStrings,
            hasComments
          });
        }, 500);
      } else {
        throw new Error('Failed to render message');
      }
    }

    // Run test on load
    window.addEventListener('load', () => {
      setTimeout(runTest, 100);
    });
  </script>
</body>
</html>
