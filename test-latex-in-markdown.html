<!DOCTYPE html>
<html lang="zh-CN" data-theme="light">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>LaTeX in Markdown æ¸²æŸ“æµ‹è¯•</title>

  <!-- KaTeX CSS -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css">

  <!-- marked.js -->
  <script src="https://cdn.jsdelivr.net/npm/marked@11.0.0/marked.min.js"></script>

  <!-- KaTeX JS -->
  <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script>

  <!-- Our styles -->
  <link rel="stylesheet" href="./src/styles/main.css">
  <link rel="stylesheet" href="./src/styles/latex-renderer.css">
  <link rel="stylesheet" href="./src/styles/chat.css">

  <style>
    body {
      padding: 20px;
      max-width: 900px;
      margin: 0 auto;
      background: var(--bg-primary);
    }

    .test-container {
      margin: 30px 0;
    }

    .test-title {
      font-size: 18px;
      font-weight: bold;
      margin-bottom: 15px;
      color: var(--text-primary);
      font-family: var(--font-heading);
      border-bottom: 2px solid var(--border-color);
      padding-bottom: 8px;
    }

    .message-container {
      background: var(--bg-secondary);
      padding: 20px;
      border-radius: var(--radius-md);
      margin: 15px 0;
    }

    .message-container.message-user {
      background: var(--active-bg);
      color: var(--active-text);
    }

    .source-code {
      background: #2a2a2a;
      color: #e0e0e0;
      padding: 15px;
      border-radius: var(--radius-sm);
      font-family: 'Monaco', 'Consolas', monospace;
      font-size: 13px;
      white-space: pre-wrap;
      margin: 10px 0;
      border-left: 3px solid #42A592;
    }

    .reference-image {
      max-width: 100%;
      border: 2px solid var(--border-color);
      border-radius: var(--radius-sm);
      margin: 15px 0;
    }

    button {
      padding: 10px 20px;
      background: var(--active-bg);
      color: var(--active-text);
      border: none;
      border-radius: var(--radius-sm);
      cursor: pointer;
      font-family: var(--font-heading);
      font-weight: 600;
      margin: 5px;
    }

    button:hover {
      opacity: 0.9;
    }

    .status {
      padding: 10px;
      border-radius: var(--radius-sm);
      margin: 10px 0;
      font-family: monospace;
      font-size: 13px;
    }

    .status.success {
      background: rgba(76, 175, 80, 0.1);
      color: #4CAF50;
      border-left: 3px solid #4CAF50;
    }

    .status.error {
      background: rgba(231, 76, 60, 0.1);
      color: #E74C3C;
      border-left: 3px solid #E74C3C;
    }

    .comparison {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
      margin: 20px 0;
    }

    .comparison-item {
      border: 2px solid var(--border-color);
      border-radius: var(--radius-sm);
      padding: 15px;
    }

    .comparison-label {
      font-weight: bold;
      margin-bottom: 10px;
      color: var(--text-primary);
      font-size: 14px;
    }
  </style>
</head>
<body>
  <h1>ğŸ§ª LaTeX in Markdown æ¸²æŸ“æµ‹è¯•</h1>

  <div style="margin: 20px 0;">
    <button onclick="runAllTests()">â–¶ï¸ è¿è¡Œæ‰€æœ‰æµ‹è¯•</button>
    <button onclick="toggleTheme()">ğŸŒ“ åˆ‡æ¢ä¸»é¢˜</button>
    <button onclick="inspectKatex()">ğŸ” æ£€æŸ¥KaTeXå…ƒç´ </button>
  </div>

  <div id="test-status" class="status" style="display:none;"></div>

  <!-- Test 1: å®Œæ•´çš„Cocoç¤ºä¾‹ -->
  <div class="test-container">
    <div class="test-title">æµ‹è¯• 1: Cocoå®Œæ•´ç¤ºä¾‹ï¼ˆç”¨æˆ·æˆªå›¾å†…å®¹ï¼‰</div>

    <div class="source-code">1. è¡Œå†…å…¬å¼æµ‹è¯•

çˆ±å› æ–¯å¦çš„è´¨èƒ½æ–¹ç¨‹æ˜¯ $E=mc_2$ï¼Œå®ƒæ”¹å˜äº†æˆ‘ä»¬å¯¹ä¸–ç•Œçš„ç†è§£ã€‚

2. ç‹¬ç«‹å…¬å¼æµ‹è¯•

ä¸€ä¸ªç»å…¸çš„ç§¯åˆ†å…¬å¼:

$$\int_a^b f(x)dx = F(b) - F(a)$$

3. çŸ©é˜µæµ‹è¯•

è¿™æ˜¯ä¸€ä¸ª $2\times 2$ çš„çŸ©é˜µ:

$$<!--LATEX_LOCK_B_0-->$$

4. å¤æ‚å…¬å¼æµ‹è¯•

é«˜æ–¯ç§¯åˆ† (Gaussian Integral):

$$\int_{-\infty}^{\infty} e^{-\frac{x^2}{2}} dx = \sqrt{\pi}$$

5. åˆ†å¼ä¸æ±‚å’Œæµ‹è¯•

æ— ç©·çº§æ•°æ±‚å’Œ:

$$\sum_{i=1}^{\infty} \frac{1}{2^i} = 1$$

6. å¸Œè…Šå­—æ¯ä¸ç¬¦å·æµ‹è¯•

$$\alpha + \beta = \gamma$$</div>

    <div class="message-container message-assistant">
      <div class="message__content" id="test1-output"></div>
    </div>
  </div>

  <!-- Test 2: è¡Œå†…å…¬å¼å¯¹é½æµ‹è¯• -->
  <div class="test-container">
    <div class="test-title">æµ‹è¯• 2: è¡Œå†…å…¬å¼åŸºçº¿å¯¹é½</div>

    <div class="source-code">æµ‹è¯•æ–‡æœ¬ $E=mc^2$ æ›´å¤šæ–‡æœ¬ $\frac{1}{2}$ ç»“æŸæ–‡æœ¬ $x^{y^z}$ å¤šå±‚ä¸Šæ ‡</div>

    <div class="message-container message-assistant">
      <div class="message__content" id="test2-output"></div>
    </div>
  </div>

  <!-- Test 3: ä¸Šä¸‹æ ‡æµ‹è¯• -->
  <div class="test-container">
    <div class="test-title">æµ‹è¯• 3: ä¸Šæ ‡å’Œä¸‹æ ‡ç²¾ç¡®å®šä½</div>

    <div class="source-code">ä¸Šæ ‡: $x^2, x^{10}, x^{abc}$

ä¸‹æ ‡: $x_1, x_{10}, x_{abc}$

åŒæ—¶: $x_1^2, x_{10}^{20}$

å¤æ‚: $\sum_{i=1}^{n} i^2 = \frac{n(n+1)(2n+1)}{6}$</div>

    <div class="message-container message-assistant">
      <div class="message__content" id="test3-output"></div>
    </div>
  </div>

  <!-- Test 4: ç§¯åˆ†å’Œæé™ -->
  <div class="test-container">
    <div class="test-title">æµ‹è¯• 4: ç§¯åˆ†å’Œæé™çš„ä¸Šä¸‹é™</div>

    <div class="source-code">ç§¯åˆ†: $\int_0^\infty e^{-x}dx$

æé™: $\lim_{x\to\infty} \frac{1}{x} = 0$

æ±‚å’Œ: $\sum_{i=1}^n i = \frac{n(n+1)}{2}$

ä¹˜ç§¯: $\prod_{i=1}^n i = n!$</div>

    <div class="message-container message-assistant">
      <div class="message__content" id="test4-output"></div>
    </div>
  </div>

  <!-- Test 5: åˆ†æ•° -->
  <div class="test-container">
    <div class="test-title">æµ‹è¯• 5: åˆ†æ•°å¯¹é½</div>

    <div class="source-code">ç®€å•åˆ†æ•°: $\frac{1}{2}, \frac{a}{b}$

å¤æ‚åˆ†æ•°: $\frac{a+b}{c+d}, \frac{\frac{1}{2}}{\frac{3}{4}}$

è¿åˆ†æ•°: $a_0 + \cfrac{1}{a_1 + \cfrac{1}{a_2}}$</div>

    <div class="message-container message-assistant">
      <div class="message__content" id="test5-output"></div>
    </div>
  </div>

  <script>
    // Import messageRenderer logic (same as before)
    const messageRenderer = {
      renderMarkdown(content) {
        if (!window.marked || !window.katex) {
          return content;
        }

        try {
          const latexBlocks = [];
          let processedContent = content;

          // Preserve display math: $$...$$
          processedContent = processedContent.replace(/\$\$([\s\S]+?)\$\$/g, (match) => {
            const index = latexBlocks.length;
            latexBlocks.push(match);
            return `LATEXBLOCKPLACEHOLDER${index}END`;
          });

          // Preserve inline math: $...$
          processedContent = processedContent.replace(/\$([^$\n]+?)\$/g, (match) => {
            const index = latexBlocks.length;
            latexBlocks.push(match);
            return `LATEXINLINEPLACEHOLDER${index}END`;
          });

          // Preserve LaTeX environments
          processedContent = processedContent.replace(/\\begin\{([^}]+)\}([\s\S]*?)\\end\{\1\}/g, (match) => {
            const index = latexBlocks.length;
            latexBlocks.push(match);
            return `LATEXBLOCKPLACEHOLDER${index}END`;
          });

          // Render Markdown
          window.marked.setOptions({
            breaks: true,
            gfm: true,
            headerIds: false,
            mangle: false,
          });
          let html = window.marked.parse(processedContent);

          // Restore and render LaTeX
          html = html.replace(/LATEXBLOCKPLACEHOLDER(\d+)END/g, (match, index) => {
            const latex = latexBlocks[parseInt(index, 10)];
            if (!latex) return match;

            let latexCode = latex;
            if (latex.startsWith('$$') && latex.endsWith('$$')) {
              latexCode = latex.slice(2, -2).trim();
            } else if (latex.match(/^\\begin\{.*\}/)) {
              latexCode = latex;
            }

            try {
              return window.katex.renderToString(latexCode, {
                displayMode: true,
                throwOnError: false,
                errorColor: '#E74C3C',
                strict: false,
                trust: false
              });
            } catch (e) {
              console.error('Block LaTeX render error:', e);
              return `<span style="color:red">[LaTeX Error: ${e.message}]</span><br><code>${latex}</code>`;
            }
          });

          html = html.replace(/LATEXINLINEPLACEHOLDER(\d+)END/g, (match, index) => {
            const latex = latexBlocks[parseInt(index, 10)];
            if (!latex) return match;

            const latexCode = latex.slice(1, -1).trim();

            try {
              return window.katex.renderToString(latexCode, {
                displayMode: false,
                throwOnError: false,
                errorColor: '#E74C3C',
                strict: false,
                trust: false
              });
            } catch (e) {
              console.error('Inline LaTeX render error:', e);
              return `<span style="color:red">[Error: ${e.message}]</span>`;
            }
          });

          return html;
        } catch (error) {
          console.error('Markdown render error:', error);
          return content;
        }
      }
    };

    function runTest(testId, content) {
      const outputEl = document.getElementById(`${testId}-output`);
      const statusEl = document.getElementById('test-status');

      try {
        statusEl.className = 'status';
        statusEl.style.display = 'block';
        statusEl.innerHTML = `â³ æ­£åœ¨æ¸²æŸ“ ${testId}...`;

        const startTime = performance.now();
        const rendered = messageRenderer.renderMarkdown(content);
        const endTime = performance.now();

        outputEl.innerHTML = rendered;

        const katexCount = outputEl.querySelectorAll('.katex').length;

        statusEl.className = 'status success';
        statusEl.innerHTML = `âœ… ${testId} æ¸²æŸ“å®Œæˆï¼è€—æ—¶: ${(endTime - startTime).toFixed(2)}ms, KaTeXå…ƒç´ : ${katexCount}ä¸ª`;

        console.log(`${testId} completed:`, {
          time: endTime - startTime,
          katexElements: katexCount,
          html: rendered.substring(0, 200)
        });

      } catch (error) {
        statusEl.className = 'status error';
        statusEl.innerHTML = `âŒ ${testId} æ¸²æŸ“å¤±è´¥: ${error.message}`;
        console.error(`${testId} error:`, error);
      }
    }

    function runAllTests() {
      console.log('\n========== å¼€å§‹æ‰€æœ‰æµ‹è¯• ==========\n');

      const tests = [
        { id: 'test1', content: document.querySelector('#test1-output').previousElementSibling.textContent },
        { id: 'test2', content: document.querySelector('#test2-output').previousElementSibling.textContent },
        { id: 'test3', content: document.querySelector('#test3-output').previousElementSibling.textContent },
        { id: 'test4', content: document.querySelector('#test4-output').previousElementSibling.textContent },
        { id: 'test5', content: document.querySelector('#test5-output').previousElementSibling.textContent },
      ];

      tests.forEach((test, index) => {
        setTimeout(() => runTest(test.id, test.content), index * 100);
      });
    }

    function toggleTheme() {
      const html = document.documentElement;
      const currentTheme = html.getAttribute('data-theme');
      const newTheme = currentTheme === 'light' ? 'dark' : 'light';
      html.setAttribute('data-theme', newTheme);
    }

    function inspectKatex() {
      const katexElements = document.querySelectorAll('.katex');
      console.log(`\n========== KaTeXå…ƒç´ æ£€æŸ¥ (å…±${katexElements.length}ä¸ª) ==========\n`);

      katexElements.forEach((el, index) => {
        const computedStyle = window.getComputedStyle(el);
        const parentStyle = window.getComputedStyle(el.parentElement);

        console.log(`KaTeX ${index + 1}:`, {
          element: el,
          content: el.textContent.substring(0, 50),
          styles: {
            fontSize: computedStyle.fontSize,
            lineHeight: computedStyle.lineHeight,
            verticalAlign: computedStyle.verticalAlign,
            display: computedStyle.display
          },
          parent: {
            lineHeight: parentStyle.lineHeight,
            fontSize: parentStyle.fontSize
          },
          classes: Array.from(el.classList),
          innerHTML: el.innerHTML.substring(0, 200)
        });
      });
    }

    // Auto-run on load
    window.addEventListener('load', () => {
      setTimeout(runAllTests, 500);
    });

    window.runTest = runTest;
    window.runAllTests = runAllTests;
    window.toggleTheme = toggleTheme;
    window.inspectKatex = inspectKatex;
  </script>
</body>
</html>
