<!DOCTYPE html>
<html lang="zh-CN" data-theme="light">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>LaTeX Rendering Test - VCPChat</title>

  <!-- KaTeX CSS -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css">

  <!-- marked.js for Markdown -->
  <script src="https://cdn.jsdelivr.net/npm/marked@11.0.0/marked.min.js"></script>

  <!-- KaTeX JS -->
  <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script>

  <link rel="stylesheet" href="./src/styles/main.css">
  <link rel="stylesheet" href="./src/styles/latex-renderer.css">
  <link rel="stylesheet" href="./src/styles/chat.css">

  <style>
    body {
      padding: 20px;
      max-width: 800px;
      margin: 0 auto;
    }

    .test-section {
      margin: 30px 0;
      padding: 20px;
      border: 2px solid var(--border-color);
      border-radius: var(--radius-md);
    }

    .test-title {
      font-size: 18px;
      font-weight: bold;
      margin-bottom: 15px;
      color: var(--text-primary);
      font-family: var(--font-heading);
    }

    .test-input {
      background: var(--bg-secondary);
      padding: 15px;
      border-radius: var(--radius-sm);
      margin-bottom: 15px;
      font-family: 'Monaco', 'Consolas', monospace;
      font-size: 13px;
      white-space: pre-wrap;
      color: var(--text-primary);
    }

    .test-output {
      background: var(--bg-primary);
      padding: 15px;
      border: 1px solid var(--border-color);
      border-radius: var(--radius-sm);
      min-height: 50px;
    }

    .debug-info {
      margin-top: 10px;
      padding: 10px;
      background: rgba(255, 193, 7, 0.1);
      border-left: 3px solid #FFA000;
      font-size: 12px;
      font-family: monospace;
      color: var(--text-secondary);
    }

    .message-bubble {
      padding: 15px;
      border-radius: 12px;
      margin: 10px 0;
      max-width: 100%;
    }

    .message-user {
      background: var(--active-bg);
      color: var(--active-text);
      margin-left: auto;
      margin-right: 0;
    }

    .message-assistant {
      background: var(--bg-secondary);
      color: var(--text-primary);
      margin-right: auto;
      margin-left: 0;
    }

    button {
      padding: 8px 16px;
      background: var(--active-bg);
      color: var(--active-text);
      border: none;
      border-radius: var(--radius-sm);
      cursor: pointer;
      font-family: var(--font-heading);
      margin: 5px;
    }

    button:hover {
      opacity: 0.9;
    }
  </style>
</head>
<body>
  <h1>LaTeX Rendering Diagnosis - VCPChat</h1>

  <div style="margin: 20px 0;">
    <button onclick="runAllTests()">ğŸ§ª Run All Tests</button>
    <button onclick="toggleTheme()">ğŸŒ“ Toggle Theme</button>
  </div>

  <!-- Test 1: Inline Math -->
  <div class="test-section">
    <div class="test-title">Test 1: è¡Œå†…å…¬å¼ (Inline Math)</div>
    <div class="test-input">åœ¨å­—ç¬¦ä¸²ä¸­åµŒå…¥å…¬å¼ï¼Œæ¯”å¦‚å› æ–¯å¦çš„è´¨èƒ½æ–¹ç¨‹ $E = mc^2$ï¼Œå¯ä»¥è¿™æ ·å†™ï¼š</div>
    <div class="test-output" id="test1-output"></div>
    <div class="debug-info" id="test1-debug"></div>
  </div>

  <!-- Test 2: Display Math -->
  <div class="test-section">
    <div class="test-title">Test 2: ç‹¬ç«‹å…¬å¼ (Block Math)</div>
    <div class="test-input">è®©å…¬å¼å•ç‹¬å æ®ä¸€è¡Œï¼Œå¹¶ä¸”å±…ä¸­æ˜¾ç¤ºï¼Œé€šå¸¸ä½¿ç”¨ $$...$$:

$$x^2 + y^2 = r^2$$</div>
    <div class="test-output" id="test2-output"></div>
    <div class="debug-info" id="test2-debug"></div>
  </div>

  <!-- Test 3: Complex Mixed Content (Coco's Example) -->
  <div class="test-section">
    <div class="test-title">Test 3: Cocoç¤ºä¾‹ - æ··åˆå†…å®¹ (Mixed Content)</div>
    <div class="test-input">å½“ç„¶! æˆ‘æ¥å¸®ä½ æµ‹è¯•ä¸€ä¸‹ LaTeX å…¬å¼çš„æ¸²æŸ“æ•ˆæœã€‚LaTeX æ˜¯ä¸€ç§éå¸¸å¼ºå¤§çš„æ’ç‰ˆç³»ç»Ÿï¼Œå°¤å…¶æ“…é•¿æ˜¾ç¤ºå¤æ‚çš„æ•°å­¦å…¬å¼ã€‚

ä¸‹é¢æ˜¯ä¸€äº›ä¸åŒç±»å‹çš„å…¬å¼ç¤ºä¾‹ï¼Œçœ‹çœ‹å®ƒä»¬æ¸²æŸ“å‡ºæ¥æ˜¯ä»€ä¹ˆæ ·å­:

1. è¡Œå†…å…¬å¼ (inline Math)

åœ¨å­—ç¬¦ä¸­åµŒå…¥å…¬å¼ï¼Œæ¯”å¦‚å› æ–¯å¦çš„è´¨èƒ½æ–¹ç¨‹ $E = mc^2$ï¼Œå¯ä»¥è¿™æ ·å†™: $E = mc^2$ï¼Œæ¸²æŸ“æ•ˆæœæ˜¯ï¼š$E = mc^2$ã€‚

å†æ¯”å¦‚ä¸€ä¸ªç®€å•çš„åˆ†æ•°ï¼š $\frac{1}{2}$ï¼Œè¿™æŸ“æ•ˆæœæ˜¯ï¼š $\frac{1}{2}$ã€‚

2. ç‹¬ç«‹å…¬å¼ (Block Math)

è®©å…¬å¼å•ç‹¬å æ®ä¸€è¡Œï¼Œå¹¶ä¸”å±…ä¸­æ˜¾ç¤ºï¼Œé€šå¸¸ä½¿ç”¨ $$...$$ åŒ…è£¹ã€‚

**ç‰¹æ®Šç¬¦å·**: å¤§éƒ¨åˆ†ç¬¦å·éƒ½æœ‰å¯¹åº”çš„å‘½ä»¤ï¼Œå¦‚ $\alpha$ (Î±), $\sum$ (âˆ‘), $\infty$ (âˆ)ã€‚

è¿™ä¸ªå¹³å°å¯¹ LaTeX çš„æ”¯æŒæœ‰æ¥å°±å¾ˆä¸é”™! å¦‚æœä½ æƒ³æµ‹è¯•å…¶ä»–ç‰¹å®šçš„å…¬å¼ï¼Œéšæ—¶å‘Šè¯‰æˆ‘ï¼Œæˆ‘å¸®ä½ å†™å‡ºæ¥çœ‹æ•ˆæœ! ğŸ˜Š</div>
    <div class="test-output message-assistant" id="test3-output"></div>
    <div class="debug-info" id="test3-debug"></div>
  </div>

  <!-- Test 4: Multiple Inline -->
  <div class="test-section">
    <div class="test-title">Test 4: å¤šä¸ªè¡Œå†…å…¬å¼ (Multiple Inline Math)</div>
    <div class="test-input">ç‰¹æ®Šç¬¦å·: å¤§éƒ¨åˆ†ç¬¦å·éƒ½æœ‰å¯¹åº”çš„å‘½ä»¤ï¼Œå¦‚ $\alpha$ (Î±), $\sum$ (âˆ‘), $\infty$ (âˆ)ã€‚</div>
    <div class="test-output" id="test4-output"></div>
    <div class="debug-info" id="test4-debug"></div>
  </div>

  <!-- Test 5: Fraction -->
  <div class="test-section">
    <div class="test-title">Test 5: åˆ†æ•° (Fractions)</div>
    <div class="test-input">å†æ¯”å¦‚ä¸€ä¸ªç®€å•çš„åˆ†æ•°ï¼š $\frac{1}{2}$ï¼Œè¿™æŸ“æ•ˆæœæ˜¯ï¼š $\frac{1}{2}$ã€‚</div>
    <div class="test-output" id="test5-output"></div>
    <div class="debug-info" id="test5-debug"></div>
  </div>

  <script type="module">
    // Import messageRenderer from source
    // For testing, we'll inline the rendering logic

    const messageRenderer = {
      /**
       * Render Markdown content with LaTeX support
       */
      renderMarkdown(content) {
        console.log('[renderMarkdown] START - content length:', content.length);
        console.log('[renderMarkdown] Content preview:', content.substring(0, 200));

        if (!window.marked) {
          console.warn('[messageRenderer] marked.js not loaded');
          return content;
        }

        try {
          // Step 1: Preserve LaTeX by replacing with HTML comment placeholders
          const latexBlocks = [];
          let processedContent = content;

          console.log('[renderMarkdown] Original content:', content);

          // Preserve display math: $$...$$
          processedContent = processedContent.replace(/\$\$([\s\S]+?)\$\$/g, (match) => {
            const index = latexBlocks.length;
            latexBlocks.push(match);
            console.log(`[renderMarkdown] Preserved display math [${index}]:`, match);
            return `<!--LATEX_BLOCK_${index}-->`;
          });

          // Preserve inline math: $...$
          processedContent = processedContent.replace(/\$([^$\n]+?)\$/g, (match) => {
            const index = latexBlocks.length;
            latexBlocks.push(match);
            console.log(`[renderMarkdown] Preserved inline math [${index}]:`, match);
            return `<!--LATEX_INLINE_${index}-->`;
          });

          // Preserve LaTeX environments: \begin{...}\end{...}
          processedContent = processedContent.replace(/\\begin\{([^}]+)\}([\s\S]*?)\\end\{\1\}/g, (match) => {
            const index = latexBlocks.length;
            latexBlocks.push(match);
            console.log(`[renderMarkdown] Preserved environment [${index}]:`, match);
            return `<!--LATEX_BLOCK_${index}-->`;
          });

          console.log('[renderMarkdown] After LaTeX preservation:', processedContent);
          console.log('[renderMarkdown] Preserved blocks count:', latexBlocks.length);

          // Step 2: Render Markdown
          window.marked.setOptions({
            breaks: true,
            gfm: true,
            headerIds: false,
            mangle: false,
          });
          let html = window.marked.parse(processedContent);

          console.log('[renderMarkdown] After marked.parse:', html.substring(0, 300));

          // Step 3: Restore and render LaTeX
          html = html.replace(/<!--LATEX_BLOCK_(\d+)-->/g, (match, index) => {
            const latex = latexBlocks[parseInt(index, 10)];
            console.log(`[renderMarkdown] Restoring block [${index}]:`, latex);

            if (!latex || !window.katex) {
              return latex || match;
            }

            // Remove delimiters and render
            let latexCode = latex;
            if (latex.startsWith('$$') && latex.endsWith('$$')) {
              latexCode = latex.slice(2, -2).trim();
            } else if (latex.match(/^\\begin\{.*\}/)) {
              latexCode = latex; // Keep environment syntax
            }

            try {
              const rendered = window.katex.renderToString(latexCode, {
                displayMode: true,
                throwOnError: false,
                errorColor: '#E74C3C'
              });
              console.log(`[renderMarkdown] Rendered block [${index}] successfully`);
              return rendered;
            } catch (e) {
              console.error('[renderMarkdown] LaTeX block render error:', e);
              return latex;
            }
          });

          html = html.replace(/<!--LATEX_INLINE_(\d+)-->/g, (match, index) => {
            const latex = latexBlocks[parseInt(index, 10)];
            console.log(`[renderMarkdown] Restoring inline [${index}]:`, latex);

            if (!latex || !window.katex) {
              return latex || match;
            }

            // Remove $ delimiters
            const latexCode = latex.slice(1, -1).trim();

            try {
              const rendered = window.katex.renderToString(latexCode, {
                displayMode: false,
                throwOnError: false,
                errorColor: '#E74C3C'
              });
              console.log(`[renderMarkdown] Rendered inline [${index}] successfully`);
              return rendered;
            } catch (e) {
              console.error('[renderMarkdown] LaTeX inline render error:', e);
              return latex;
            }
          });

          console.log('[renderMarkdown] Final HTML:', html.substring(0, 300));
          return html;

        } catch (error) {
          console.error('[renderMarkdown] Error:', error);
          return content;
        }
      }
    };

    function runTest(testId, content) {
      const outputEl = document.getElementById(`${testId}-output`);
      const debugEl = document.getElementById(`${testId}-debug`);

      console.log(`\n========== ${testId.toUpperCase()} ==========`);

      const startTime = performance.now();
      const rendered = messageRenderer.renderMarkdown(content);
      const endTime = performance.now();

      outputEl.innerHTML = rendered;

      // Debug info
      const latexCount = (content.match(/\$[^$]+\$/g) || []).length;
      const displayCount = (content.match(/\$\$[\s\S]+?\$\$/g) || []).length;

      debugEl.innerHTML = `
        <strong>Debug Info:</strong><br>
        - Content length: ${content.length} chars<br>
        - Inline math found: ${latexCount}<br>
        - Display math found: ${displayCount}<br>
        - Render time: ${(endTime - startTime).toFixed(2)}ms<br>
        - KaTeX elements: ${outputEl.querySelectorAll('.katex').length}
      `;

      console.log(`${testId} completed in ${(endTime - startTime).toFixed(2)}ms`);
    }

    function runAllTests() {
      const tests = [
        { id: 'test1', content: document.querySelector('#test1-output').previousElementSibling.textContent },
        { id: 'test2', content: document.querySelector('#test2-output').previousElementSibling.textContent },
        { id: 'test3', content: document.querySelector('#test3-output').previousElementSibling.textContent },
        { id: 'test4', content: document.querySelector('#test4-output').previousElementSibling.textContent },
        { id: 'test5', content: document.querySelector('#test5-output').previousElementSibling.textContent },
      ];

      tests.forEach(test => runTest(test.id, test.content));
    }

    function toggleTheme() {
      const html = document.documentElement;
      const currentTheme = html.getAttribute('data-theme');
      const newTheme = currentTheme === 'light' ? 'dark' : 'light';
      html.setAttribute('data-theme', newTheme);
    }

    // Auto-run tests on load
    window.addEventListener('load', () => {
      console.log('Page loaded, running tests...');
      setTimeout(runAllTests, 500);
    });

    // Expose for manual testing
    window.runTest = runTest;
    window.runAllTests = runAllTests;
    window.toggleTheme = toggleTheme;
    window.messageRenderer = messageRenderer;
  </script>
</body>
</html>
