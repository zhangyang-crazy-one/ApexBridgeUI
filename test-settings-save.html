<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Test Settings Save Fix</title>
  <style>
    body {
      font-family: system-ui, -apple-system, sans-serif;
      max-width: 800px;
      margin: 40px auto;
      padding: 20px;
      background: #f5f5f5;
    }
    .test-section {
      background: white;
      padding: 20px;
      margin: 20px 0;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    h2 {
      margin-top: 0;
      color: #333;
    }
    .result {
      padding: 10px;
      margin: 10px 0;
      border-radius: 4px;
      font-family: 'Courier New', monospace;
      font-size: 14px;
    }
    .success {
      background: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
    }
    .error {
      background: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
    }
    button {
      background: #007bff;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
    }
    button:hover {
      background: #0056b3;
    }
    pre {
      background: #f8f9fa;
      padding: 10px;
      border-radius: 4px;
      overflow-x: auto;
    }
  </style>
</head>
<body>
  <h1>Settings Save Function Test</h1>

  <div class="test-section">
    <h2>Test 1: Language Format Validation</h2>
    <p>Testing that language is properly formatted as 'en-US' or 'zh-CN'</p>
    <button onclick="testLanguageFormat()">Run Test</button>
    <div id="lang-result"></div>
  </div>

  <div class="test-section">
    <h2>Test 2: Transparency Conversion</h2>
    <p>Testing that transparency converts correctly between percentage (50-100) and decimal (0.5-1.0)</p>
    <button onclick="testTransparencyConversion()">Run Test</button>
    <div id="transparency-result"></div>
  </div>

  <div class="test-section">
    <h2>Test 3: DOM Timing Fix</h2>
    <p>Testing that event listeners attach after setTimeout</p>
    <button onclick="testDOMTiming()">Run Test</button>
    <div id="dom-result"></div>
  </div>

  <div class="test-section">
    <h2>Test 4: Complete Settings Save Flow</h2>
    <p>Full integration test of the save functionality</p>
    <button onclick="testCompleteSave()">Run Test</button>
    <div id="save-result"></div>
  </div>

  <script type="module">
    // Import the validation function
    function validateSettings(settings) {
      // Validate URL
      try {
        new URL(settings.backend_url);
      } catch {
        return 'Settings backend_url must be a valid HTTP(S) URL';
      }

      // Validate language
      if (settings.language !== 'zh-CN' && settings.language !== 'en-US') {
        return 'Settings language must be "zh-CN" or "en-US"';
      }

      // Validate transparency
      if (settings.window_preferences.transparency < 0.0 || settings.window_preferences.transparency > 1.0) {
        return 'Settings window transparency must be between 0.0 and 1.0';
      }

      return null; // Valid
    }

    window.validateSettings = validateSettings;

    // Test 1: Language Format
    window.testLanguageFormat = function() {
      const resultDiv = document.getElementById('lang-result');
      const tests = [
        { lang: 'en', expected: 'FAIL', reason: 'Should reject "en"' },
        { lang: 'zh', expected: 'FAIL', reason: 'Should reject "zh"' },
        { lang: 'en-US', expected: 'PASS', reason: 'Should accept "en-US"' },
        { lang: 'zh-CN', expected: 'PASS', reason: 'Should accept "zh-CN"' }
      ];

      let html = '<h3>Test Results:</h3>';
      let allPassed = true;

      tests.forEach(test => {
        const settings = {
          backend_url: 'http://localhost:6005/v1/chat/completions',
          language: test.lang,
          window_preferences: { transparency: 0.8 }
        };

        const error = validateSettings(settings);
        const actualResult = error ? 'FAIL' : 'PASS';
        const passed = actualResult === test.expected;

        if (!passed) allPassed = false;

        html += `<div class="${passed ? 'success' : 'error'} result">
          ${passed ? '✓' : '✗'} Language "${test.lang}": ${actualResult} (${test.reason})
        </div>`;
      });

      resultDiv.innerHTML = html + `<div class="${allPassed ? 'success' : 'error'} result">
        <strong>${allPassed ? '✓ All language tests passed!' : '✗ Some tests failed'}</strong>
      </div>`;
    };

    // Test 2: Transparency Conversion
    window.testTransparencyConversion = function() {
      const resultDiv = document.getElementById('transparency-result');
      const tests = [
        { percent: 50, decimal: 0.5 },
        { percent: 75, decimal: 0.75 },
        { percent: 100, decimal: 1.0 }
      ];

      let html = '<h3>Test Results:</h3>';
      let allPassed = true;

      tests.forEach(test => {
        // Test percentage to decimal conversion
        const convertedDecimal = test.percent / 100;
        const decimalCorrect = Math.abs(convertedDecimal - test.decimal) < 0.001;

        // Test decimal to percentage conversion
        const convertedPercent = Math.round(test.decimal * 100);
        const percentCorrect = convertedPercent === test.percent;

        // Validate the decimal value
        const settings = {
          backend_url: 'http://localhost:6005/v1/chat/completions',
          language: 'en-US',
          window_preferences: { transparency: convertedDecimal }
        };
        const error = validateSettings(settings);
        const validationPassed = !error;

        const passed = decimalCorrect && percentCorrect && validationPassed;
        if (!passed) allPassed = false;

        html += `<div class="${passed ? 'success' : 'error'} result">
          ${passed ? '✓' : '✗'} ${test.percent}% ↔ ${test.decimal}: ${convertedDecimal.toFixed(2)}
          (Validation: ${validationPassed ? 'PASS' : 'FAIL'})
        </div>`;
      });

      resultDiv.innerHTML = html + `<div class="${allPassed ? 'success' : 'error'} result">
        <strong>${allPassed ? '✓ All transparency tests passed!' : '✗ Some tests failed'}</strong>
      </div>`;
    };

    // Test 3: DOM Timing
    window.testDOMTiming = function() {
      const resultDiv = document.getElementById('dom-result');
      const container = document.createElement('div');
      document.body.appendChild(container);

      let html = '<h3>Test Results:</h3>';

      // Test 1: Immediate access (should fail)
      container.innerHTML = '<input id="test-immediate" type="text">';
      const immediateElement = document.getElementById('test-immediate');
      const immediateFound = immediateElement !== null;

      html += `<div class="${immediateFound ? 'success' : 'error'} result">
        ${immediateFound ? '✓' : '✗'} Immediate access after innerHTML: ${immediateFound ? 'FOUND' : 'NOT FOUND'}
        ${!immediateFound ? ' (This is actually EXPECTED to fail on some browsers)' : ''}
      </div>`;

      // Test 2: setTimeout access (should succeed)
      container.innerHTML = '<input id="test-deferred" type="text">';
      setTimeout(() => {
        const deferredElement = document.getElementById('test-deferred');
        const deferredFound = deferredElement !== null;

        html += `<div class="${deferredFound ? 'success' : 'error'} result">
          ${deferredFound ? '✓' : '✗'} setTimeout(0) access after innerHTML: ${deferredFound ? 'FOUND' : 'NOT FOUND'}
        </div>`;

        html += `<div class="success result">
          <strong>✓ DOM timing test complete!</strong><br>
          <small>The fix uses setTimeout(() => attachListeners(), 0) to ensure elements are found</small>
        </div>`;

        resultDiv.innerHTML = html;
        container.remove();
      }, 0);

      resultDiv.innerHTML = html + '<div class="result">⏳ Waiting for setTimeout test...</div>';
    };

    // Test 4: Complete Save Flow
    window.testCompleteSave = function() {
      const resultDiv = document.getElementById('save-result');

      // Simulate the complete save flow
      const mockFormData = {
        backend_url: 'http://localhost:6005/v1/chat/completions',
        api_key: 'test-key',
        user_name: 'TestUser',
        user_avatar: '',
        theme: 'light',
        language: 'en-US',  // Correct format (not 'en')
        window_preferences: {
          always_on_top: false,
          transparency: 0.75,  // Correct decimal (not 75)
          startup_behavior: 'normal'
        },
        sidebar_preferences: {
          default_width: 300,
          min_width: 200,
          max_width: 600
        }
      };

      const error = validateSettings(mockFormData);

      let html = '<h3>Complete Save Flow Test:</h3>';
      html += '<pre>' + JSON.stringify(mockFormData, null, 2) + '</pre>';

      if (error) {
        html += `<div class="error result">✗ Validation Failed: ${error}</div>`;
      } else {
        html += `<div class="success result">✓ Validation Passed!</div>`;

        // Try to save to localStorage
        try {
          localStorage.setItem('vcpchat_settings', JSON.stringify(mockFormData));
          const saved = localStorage.getItem('vcpchat_settings');
          const parsed = JSON.parse(saved);

          html += `<div class="success result">✓ Successfully saved to localStorage</div>`;
          html += `<div class="success result">✓ Successfully retrieved from localStorage</div>`;
          html += '<h4>Retrieved Data:</h4>';
          html += '<pre>' + JSON.stringify(parsed, null, 2) + '</pre>';

          // Verify specific fields
          const checks = [
            { field: 'language', expected: 'en-US', actual: parsed.language },
            { field: 'transparency', expected: 0.75, actual: parsed.window_preferences.transparency },
            { field: 'user_name', expected: 'TestUser', actual: parsed.user_name }
          ];

          html += '<h4>Field Verification:</h4>';
          checks.forEach(check => {
            const passed = check.expected === check.actual;
            html += `<div class="${passed ? 'success' : 'error'} result">
              ${passed ? '✓' : '✗'} ${check.field}: ${check.actual} ${passed ? '(correct)' : `(expected ${check.expected})`}
            </div>`;
          });

        } catch (e) {
          html += `<div class="error result">✗ localStorage error: ${e.message}</div>`;
        }
      }

      resultDiv.innerHTML = html;
    };
  </script>
</body>
</html>
